{"version":3,"sources":["shmile-ui.js"],"names":["CameraUtils","snap","photoView","idx","cheeseCb","zoomFrame","modalMessage","Config","ready_delay","scale4x6","maxw","maxh","s0","s1","w","h","photo_margin","window_width","$","window","width","window_height","height","overlay_delay","next_delay","cheese_delay","flash_duration","nice_delay","between_snap_delay","is_mobile","AppState","this","reset","prototype","current_frame_idx","zoomed","ShmileStateMachine","socket","appState","config","buttonView","self","fsm","StateMachine","create","initial","events","name","from","to","callbacks","onconnected","animate","fadeIn","onenterready","resetState","onleaveready","onenterwaiting_for_photo","e","flashStart","emit","onphoto_saved","f","t","data","flashEnd","updatePhotoSet","web_url","setTimeout","photo_updated","onphoto_updated","finish_set","continue_partial_set","onenterreview_composited","showOverlay","next_set","onleavereview_composited","slideInNext","onchangestate","console","log","StateMachineEventHandler","stateMachine","channel","init","bind","ui_button_pressed","SocketProxy","fakeSocket","_","extend","Backbone","Events","lateInitialize","on","evt","cb","msg","trigger","SocketLayer","io","proxy","connect","register","connected","filename","photo_saved","PhotoView","View","id","initialize","state","canvas","Raphael","frames","set","images","all","overlayImage","photoBorder","compositeDim","frameDim","compositeOrigin","compositeCenter","render","x","y","r","rect","attr","fill","push","frame_x","frame_y","frame","img","image","clone","translate","o","hide","toString","ret","length","join","img_src","view","imgEl","frameEl","src","opacity","show","afterShowPhoto","p","dir","translation","onfinish","frameX","frameW","frameY","frameH","centerX","centerY","animSpeed","dx","dy","scaleFactor","scale","flashEffect","duration","undefined","remove","text","persistTime","animateSpeed","sideLength","fill-opacity","stroke-color","txt","font-size","font-weight","hideOverlay","ButtonView","startButton","buttonX","outerWidth","buttonY","outerHeight","css","top","left","buttonTriggerEvt","button","currentTarget","fadeOut","Shmile","socketProxy","bv","ssm","layer"],"mappings":"AAGC,GAAIA,aAAc,YAYnBA,aAAYC,KAAO,SAASC,EAAWC,EAAKC,GAC1CF,EAAUG,UAAUF,EAAK,MAEzBD,EAAUI,aAAa,SAAUC,OAAOC,YAAa,IAAK,WACxDN,EAAUI,aAAa,IAAK,IAAM,IAAK,WACrCJ,EAAUI,aAAa,IAAK,IAAM,IAAM,WACtCJ,EAAUI,aAAa,IAAK,IAAM,IAAK,WACrCF,aAWVJ,YAAYS,SAAW,SAASC,EAAMC,GAClC,GAAIC,GAAK,IACLC,EAAKH,EAAKC,CAGd,OAAUE,IAAND,GACQE,EAAU,EAAPH,EAAS,EAAGI,EAAGJ,IAElBG,EAAGJ,EAAMK,EAAU,EAAPL,EAAS,GAIrC,IAAIH,SACFS,aAAc,GACdC,aAAcC,EAAEC,QAAQC,QACxBC,cAAeH,EAAEC,QAAQG,SAAW,GACpCC,cAAe,IACfC,WAAY,IACZC,aAAc,IACdC,eAAgB,IAChBlB,YAAa,IACbmB,WAAY,IAMZC,mBAAoB,IAGpBC,WAAW,GAMTC,SAAW,WACbC,KAAKC,QAGPF,UAASG,UAAUD,MAAQ,WACzBD,KAAKG,kBAAoB,EACzBH,KAAKI,OAAS,KAyBhB,IAAIC,oBAAqB,SAASlC,EAAWmC,EAAQC,EAAUC,EAAQC,GACrET,KAAK7B,UAAYA,EACjB6B,KAAKM,OAASA,EACdN,KAAKO,SAAWA,EAChBP,KAAKQ,OAASA,EACdR,KAAKS,WAAaA,CAElB,IAAIC,GAAOV,IAEXA,MAAKW,IAAMC,aAAaC,QACtBC,QAAS,UACTC,SACIC,KAAM,YAAaC,KAAM,UAAWC,GAAI,UACxCF,KAAM,oBAAqBC,KAAM,QAASC,GAAI,sBAC9CF,KAAM,cAAeC,KAAM,oBAAqBC,GAAI,iBACpDF,KAAM,gBAAiBC,KAAM,eAAgBC,GAAI,eACjDF,KAAM,uBAAwBC,KAAM,aAAcC,GAAI,sBACtDF,KAAM,aAAcC,KAAM,aAAcC,GAAI,sBAC5CF,KAAM,WAAYC,KAAM,oBAAqBC,GAAI,UAErDC,WACEC,YAAa,WACXV,EAAKvC,UAAUkD,QAAQ,KAAM,WAC3BX,EAAKD,WAAWa,YAGpBC,aAAc,WACZb,EAAKvC,UAAUqD,cAEjBC,aAAc,aAEdC,yBAA0B,SAASC,GACjCtD,SAAW,WACTqC,EAAKvC,UAAUI,aAAa,UAAWmC,EAAKF,OAAOd,cACnDgB,EAAKvC,UAAUyD,aACflB,EAAKJ,OAAOuB,KAAK,QAAQ,IAE3B5D,YAAYC,KAAKwC,EAAKvC,UACjBuC,EAAKH,SAASJ,kBACd9B,WAEPyD,cAAe,SAASH,EAAGI,EAAGC,EAAGC,GAG/BvB,EAAKvC,UAAU+D,WACfxB,EAAKvC,UAAUgE,eAAeF,EAAKG,QAAS1B,EAAKH,SAASJ,kBAAmB,WAC3EkC,WAAW,WACT3B,EAAKC,IAAI2B,iBACR5B,EAAKF,OAAOX,uBAGnB0C,gBAAiB,SAASZ,EAAGI,EAAGC,GAC9BtB,EAAKvC,UAAU+D,WAEwB,GAAnCxB,EAAKH,SAASJ,kBAChBO,EAAKC,IAAI6B,cAIT9B,EAAKH,SAASJ,mBAAqBO,EAAKH,SAASJ,kBAAoB,GAAK,EAC1EO,EAAKC,IAAI8B,yBAGbC,yBAA0B,SAASf,EAAGI,EAAGC,GACvCtB,EAAKJ,OAAOuB,KAAK,aACjBnB,EAAKvC,UAAUwE,aAAY,GAC3BN,WAAW,WACT3B,EAAKC,IAAIiC,YACRlC,EAAKF,OAAOf,aAEjBoD,yBAA0B,SAASlB,EAAGI,EAAGC,GAEvCtB,EAAKvC,UAAUkD,QAAQ,OACvBX,EAAKvC,UAAUI,aAAa,QAASmC,EAAKF,OAAOZ,WAAY,IAAK,WAChEc,EAAKvC,UAAU2E,iBAGnBC,cAAe,SAASpB,EAAGI,EAAGC,GAC5BgB,QAAQC,IAAI,sBAAuBtB,EAAG,yBAA2BI,EAAI,OAASC,QASlFkB,yBAA2B,SAASC,EAAcC,GACrDpD,KAAKmD,aAAeA,EACpBnD,KAAKoD,QAAUA,EAGhBF,0BAAyBhD,UAAUmD,KAAO,WACzC,GAAI3C,GAAOV,IACXA,MAAKoD,QAAQE,KAAK,oBAAqB,WACtC5C,EAAKyC,aAAaxC,IAAI4C,sBAUxB,IAAIC,aAAc,WAChBxD,KAAKM,OAAS,KACdN,KAAKyD,cACLC,EAAEC,OAAO3D,KAAKyD,WAAYG,SAASC,QAGrCL,aAAYtD,UAAU4D,eAAiB,SAASxD,GAC9CN,KAAKM,OAASA,GAGhBkD,YAAYtD,UAAU6D,GAAK,SAASC,EAAKC,GACvC,MAAoB,QAAhBjE,KAAKM,QACP0C,QAAQC,IAAI,iDACZjD,MAAKyD,WAAWM,GAAGC,EAAKC,QAG1BjE,MAAKM,OAAOyD,GAAGC,EAAKC,IAGtBT,YAAYtD,UAAU2B,KAAO,SAASqC,EAAKjC,GACzC,MAAoB,QAAhBjC,KAAKM,QACP0C,QAAQC,IAAI,mDACZjD,MAAKyD,WAAWU,QAAQD,EAAK,WAC3BlB,QAAQC,IAAIhB,UAIhBjC,MAAKM,OAAOuB,KAAKqC,EAAKjC,GAQxB,IAAImC,aAAc,SAASC,EAAIC,GAC7BtE,KAAKqE,GAAKA,EACVrE,KAAKsE,MAAQA,EAOfF,aAAYlE,UAAUmD,KAAO,WAC3B,IACErD,KAAKM,OAASN,KAAKqE,GAAGE,QAAQ,KAC9BvE,KAAKsE,MAAMR,eAAe9D,KAAKM,QAC/B,MAAMqB,GACNqB,QAAQC,IAAI,yCAA2CtB,GAEzD,MAAO3B,OAMToE,YAAYlE,UAAUsE,SAAW,SAAS7D,GACxCX,KAAKW,IAAMA,CACX,IAAID,GAAOV,IAEXA,MAAKsE,MAAMP,GAAG,UAAW,SAAS9B,GAChCe,QAAQC,IAAI,wBAA0BhB,KAGxCjC,KAAKsE,MAAMP,GAAG,UAAW,WACvBf,QAAQC,IAAI,iBACZvC,EAAKC,IAAI8D,cAGXzE,KAAKsE,MAAMP,GAAG,iBAAkB,WAC9Bf,QAAQC,IAAI,wBAIdjD,KAAKsE,MAAMP,GAAG,cAAe,SAAS9B,GACpCe,QAAQC,IAAI,oBAAsBhB,EAAKyC,UACvChE,EAAKC,IAAIgE,YAAY1C,KAIzB,IAAI2C,WAAYhB,SAASiB,KAAKlB,QAC5BmB,GAAI,YAEJC,WAAY,SAASvE,EAAQwE,GAC3BhF,KAAKQ,OAASA,EACdR,KAAKiF,OAAS,GAAIC,SAAQ,WAAYlF,KAAKQ,OAAOtB,aAAcc,KAAKQ,OAAOlB,eAC5EU,KAAKmF,OAASnF,KAAKiF,OAAOG,MAC1BpF,KAAKqF,OAASrF,KAAKiF,OAAOG,MAC1BpF,KAAKsF,IAAMtF,KAAKiF,OAAOG,MACvBpF,KAAKuF,aAAe,KACpBvF,KAAKwF,YAAc,EACnBxF,KAAKyF,aAAe,KACpBzF,KAAK0F,SAAW,KAChB1F,KAAK2F,gBAAkB,KACvB3F,KAAK4F,gBAAkB,KACvB5F,KAAKgF,MAAQA,GAGfa,OAAQ,WACN,GAAI9G,GAAIiB,KAAKQ,OAAOtB,aAAec,KAAKQ,OAAOvB,aAC3CD,EAAIgB,KAAKQ,OAAOlB,cAAgBU,KAAKQ,OAAOvB,YAChDe,MAAKyF,aAAexH,YAAYS,SAASK,EAAGC,GAC5CgB,KAAK2F,iBACDG,GAAI9F,KAAKQ,OAAOtB,aAAec,KAAKyF,aAAa1G,GAAK,EACtDgH,GAAI/F,KAAKQ,OAAOlB,cAAgBU,KAAKyF,aAAazG,GAAK,GAE3DgB,KAAK4F,iBACDE,EAAG9F,KAAK2F,gBAAgBG,EAAK9F,KAAKyF,aAAa1G,EAAE,EACjDgH,EAAG/F,KAAK2F,gBAAgBI,EAAK/F,KAAKyF,aAAazG,EAAE,EAErD,IAAIgH,GAAIhG,KAAKiF,OAAOgB,KAAKjG,KAAK2F,gBAAgBG,EAAG9F,KAAK2F,gBAAgBI,EAAG/F,KAAKyF,aAAa1G,EAAGiB,KAAKyF,aAAazG,EAEhHgH,GAAEE,MAAMC,KAAQ,UAEhBnG,KAAKsF,IAAIc,KAAKJ,GAGdhG,KAAKwF,YAAcxF,KAAKyF,aAAa1G,EAAI,EAGzC,IAAIsH,GAAUrG,KAAK2F,gBAAgBG,EAAI9F,KAAKwF,YACxCc,EAAUtG,KAAK2F,gBAAgBI,EAAI/F,KAAKwF,WAC5CxF,MAAK0F,UACD3G,GAAIiB,KAAKyF,aAAa1G,EAAK,EAAEiB,KAAKwF,aAAc,EAChDxG,GAAIgB,KAAKyF,aAAazG,EAAK,EAAEgB,KAAKwF,aAAc,EAEpD,IAAIe,GAAQvG,KAAKiF,OAAOgB,KAAKI,EAASC,EAAStG,KAAK0F,SAAS3G,EAAGiB,KAAK0F,SAAS1G,EAC9EuH,GAAML,MAAMC,KAAQ,SACpB,IAAIK,GAAMxG,KAAKiF,OAAOwB,MAAM,KAAMJ,EAASC,EAAStG,KAAK0F,SAAS3G,EAAGiB,KAAK0F,SAAS1G,EAEnFgB,MAAKqF,OAAOe,KAAKI,GACjBxG,KAAKmF,OAAOiB,KAAKG,GACjBvG,KAAKsF,IAAIc,KAAKI,GACdxG,KAAKsF,IAAIc,KAAKG,GAEdA,EAAQA,EAAMG,QACdF,EAAMA,EAAIE,QACVH,EAAMI,UAAU3G,KAAK0F,SAAS3G,EAAIiB,KAAKwF,YAAa,GACpDgB,EAAIG,UAAU3G,KAAK0F,SAAS3G,EAAIiB,KAAKwF,YAAa,GAClDxF,KAAKmF,OAAOiB,KAAKG,GACjBvG,KAAKqF,OAAOe,KAAKI,GACjBxG,KAAKsF,IAAIc,KAAKG,GACdvG,KAAKsF,IAAIc,KAAKI,GAEdD,EAAQA,EAAMG,QACdF,EAAMA,EAAIE,QACVH,EAAMI,YAAY3G,KAAK0F,SAAS3G,EAAIiB,KAAKwF,aAAcxF,KAAK0F,SAAS1G,EAAIgB,KAAKwF,aAC9EgB,EAAIG,YAAY3G,KAAK0F,SAAS3G,EAAIiB,KAAKwF,aAAcxF,KAAK0F,SAAS1G,EAAIgB,KAAKwF,aAC5ExF,KAAKmF,OAAOiB,KAAKG,GACjBvG,KAAKqF,OAAOe,KAAKI,GACjBxG,KAAKsF,IAAIc,KAAKG,GACdvG,KAAKsF,IAAIc,KAAKI,GAEdD,EAAQA,EAAMG,QACdF,EAAMA,EAAIE,QACVH,EAAMI,UAAU3G,KAAK0F,SAAS3G,EAAIiB,KAAKwF,YAAa,GACpDgB,EAAIG,UAAU3G,KAAK0F,SAAS3G,EAAIiB,KAAKwF,YAAa,GAClDxF,KAAKmF,OAAOiB,KAAKG,GACjBvG,KAAKqF,OAAOe,KAAKI,GACjBxG,KAAKsF,IAAIc,KAAKG,GACdvG,KAAKsF,IAAIc,KAAKI,EAGd,IAAII,GAAI5G,KAAKiF,OAAOwB,MAChB,sBACAzG,KAAK2F,gBAAgBG,EACrB9F,KAAK2F,gBAAgBI,EACrB/F,KAAKyF,aAAa1G,EAClBiB,KAAKyF,aAAazG,EACtBgB,MAAKsF,IAAIc,KAAKQ,GACd5G,KAAKuF,aAAeqB,EAGpB5G,KAAKsF,IAAIuB,OACT7G,KAAKsF,IAAIqB,WAAW3G,KAAKQ,OAAOtB,aAAc,IAGhD4H,SAAU,WAMR,MALAC,QACAA,IAAIX,KAAK,sBAAwBpG,KAAKsF,IAAI0B,QAC1CD,IAAIX,KAAK,yBAA2BpG,KAAKmF,OAAO6B,QAChDD,IAAIX,KAAK,uBAAyBpG,KAAKsF,IAAI,GAAGY,KAAK,SAAW,IAAMlG,KAAKsF,IAAI,GAAGY,KAAK,WACrFa,IAAIX,KAAK,mBAAqBpG,KAAK0F,SAAS3G,EAAI,IAAMiB,KAAK0F,SAAS1G,GAC7D+H,IAAIE,KAAK,OAYlB9E,eAAgB,SAAS+E,EAAS9I,EAAK6F,GACrC,GAAIkD,GAAOnH,KACPoH,EAAQD,EAAK9B,OAAOjH,GACpBiJ,EAAUF,EAAKhC,OAAO/G,EAE1BgJ,GAAMlB,MAAMoB,IAAOJ,EAASK,QAAW,IACvCH,EAAMI,MAEN,IAAIC,GAAiB,WAEnBJ,EAAQR,OACRa,EAAEpJ,UAAUF,EAAK,MAAO6F,GAE1BmD,GAAM/F,SAASkG,QAAW,GAAI,IAAKE,IAQrCpG,QAAS,SAASsG,EAAK1D,GACT,OAAR0D,GACF3H,KAAKsF,IAAIkC,OACTxH,KAAKqF,OAAOwB,OACZ7G,KAAKuF,aAAasB,OAClB7G,KAAKsF,IAAIjE,SACPuG,YAAe5H,KAAKQ,OAAOtB,aAAa,MACvC,IAAM,KAAM+E,IACE,QAAR0D,GACT3H,KAAKsF,IAAIjE,SACPuG,YAAe5H,KAAKQ,OAAOtB,aAAa,MACvC,IAAM,KAAM+E,IAkBnB3F,UAAW,SAASF,EAAKuJ,EAAKE,GAC1B,GAAIV,GAAOnH,KAGPuG,GAFYvG,KAAKsF,IAAIlH,GAEb4B,KAAKmF,OAAO/G,IACpB0J,EAASvB,EAAML,KAAK,KACpB6B,EAASxB,EAAML,KAAK,SACpB8B,EAASzB,EAAML,KAAK,KACpB+B,EAAS1B,EAAML,KAAK,UACpBgC,EAAUJ,EAASC,EAAO,EAC1BI,EAAUH,EAASC,EAAO,EAE1BG,EAAY,IAGZC,EAAKrI,KAAK4F,gBAAgBE,EAAIoC,EAC9BI,EAAKtI,KAAK4F,gBAAgBG,EAAIoC,EAC9BI,EAAcvI,KAAKyF,aAAa1G,EAAIiB,KAAK0F,SAAS3G,CAE1C,SAAR4I,GAAiB3H,KAAKgF,MAAM5E,QAC5BmI,EAAc,EACdF,GAAMrI,KAAKgF,MAAM5E,OAAOiI,GACxBC,GAAMtI,KAAKgF,MAAM5E,OAAOkI,GACxBnB,EAAK7B,IAAIjE,SACLmH,OAAU,EAAG,EAAGrB,EAAKvB,gBAAgBE,EAAGqB,EAAKvB,gBAAgBG,GAAGkB,KAAK,MACtEmB,EAAW,SAAU,WACpBjB,EAAK7B,IAAIjE,SACLuG,YAAeS,EAAG,IAAIC,GACvBF,EAAW,KAAMP,KAGxB7H,KAAKgF,MAAM5E,OAAS,MACL,QAARuH,IACPR,EAAK7B,IAAIjE,SACLuG,YAAeS,EAAG,IAAIC,GACvBF,EAAW,KAAM,WAChBjB,EAAK7B,IAAIjE,SACLmH,OAAUD,EAAaA,EAAapB,EAAKvB,gBAAgBE,EAAGqB,EAAKvB,gBAAgBG,GAAGkB,KAAK,MAC1FmB,EAAW,SAAUP,KAG5B7H,KAAKgF,MAAM5E,QACPiI,GAAIA,EACJC,GAAIA,EACJC,YAAaA,KAQzBzF,YAAa,WACT9C,KAAKwB,aACLxB,KAAKzB,aAAa,SAClByB,KAAKsF,IAAIuB,OACT7G,KAAKsF,IAAIqB,UAAsC,GAA3B3G,KAAKQ,OAAOtB,aAAkB,GAClDc,KAAKqB,QAAQ,KAAM,WACjBlC,EAAE,iBAAiBmC,YAOzBE,WAAY,WACVxB,KAAKgF,MAAM/E,SAMbwI,YAAa,SAASC,GACHC,SAAbD,IAA0BA,EAAW,IACzC,IAAIzC,GAAOjG,KAAKiF,OAAOgB,KAAK,EAAG,EAAGjG,KAAKQ,OAAOtB,aAAcc,KAAKQ,OAAOlB,cACxE2G,GAAKC,MAAMC,KAAQ,QAASoB,QAAW,IACvCtB,EAAK5E,SAASkG,QAAW,GAAImB,EAAU,IAAK,WAC1CzC,EAAK5E,SAASkG,QAAW,GAAImB,EAAU,KACvCzC,EAAK2C,YAIThH,WAAY,SAAS8G,GACFC,SAAbD,IAA0BA,EAAW,KACzC1I,KAAKiG,KAAOjG,KAAKiF,OAAOgB,KAAK,EAAG,EAAGjG,KAAKQ,OAAOtB,aAAcc,KAAKQ,OAAOlB,eACzEU,KAAKiG,KAAKC,MAAMC,KAAQ,QAASoB,QAAW,IAC5CvH,KAAKiG,KAAK5E,SAASkG,QAAW,GAAImB,EAAU,MAG9CxG,SAAU,SAASwG,GACAC,SAAbD,IAA0BA,EAAW,IACzC,IAAIhI,GAAOV,IACXA,MAAKiG,KAAK5E,SAASkG,QAAW,GAAImB,EAAU,IAAK,WAC/ChI,EAAKkI,YAOTrK,aAAc,SAASsK,EAAMC,EAAaC,EAAc9E,GACpD,GAAqB0E,SAAjBI,EAA8B,GAAIA,GAAe,GACrD,IAAoBJ,SAAhBG,EAA6B,GAAIA,GAAc,GAEnD,IAAIE,GAAyC,GAA5BhJ,KAAKQ,OAAOlB,cACzBwG,GAAK9F,KAAKQ,OAAOtB,aAAe8J,GAAY,EAC5CjD,GAAK/F,KAAKQ,OAAOlB,cAAgB0J,GAAY,EAC7C1D,EAAMtF,KAAKiF,OAAOG,MAClBY,EAAIhG,KAAKiF,OAAOgB,KAAKH,EAAGC,EACxBiD,EACAA,EACA,GACJhD,GAAEE,MAAMC,KAAQ,OACR8C,eAAgB,GAChBC,eAAgB,UACxB5D,EAAIc,KAAKJ,EACT,IAAImD,GAAMnJ,KAAKiF,OAAO4D,KAAK/C,EAAIkD,EAAW,EAAGjD,EAAIiD,EAAW,EAAGH,EAC/DM,GAAIjD,MAAMC,KAAQ,QACdiD,YAAa,KACbC,cAAe,SAEnB/D,EAAIc,KAAK+C,GACT7D,EAAIY,MAAMqB,QAAW,IACrBjC,EAAIjE,SACAkG,QAAW,EACXiB,MAAS,UACTY,YAAa,MACdL,EAAc,IAGT1G,YAAW,SAASiD,GAExB6D,EAAIP,SACJ5C,EAAE4C,SACE3E,GAAIA,KACT6E,EAAaxD,IAOpB3C,YAAa,SAAStB,GAClBrB,KAAKuF,aAAaiC,OACdnG,GAEFrB,KAAKuF,aAAalE,SAASkG,QAAU,GAAIvH,KAAKQ,OAAOhB,gBAO3D8J,YAAa,SAASjI,GACpB,GAAI8F,GAAOnH,IACPqB,GACFrB,KAAKuF,aAAalE,SAASkG,QAAU,GAAIvH,KAAKQ,OAAOhB,cAAe,WAClE2H,EAAK5B,aAAasB,SAGpB7G,KAAKuF,aAAasB,UAKpB0C,WAAa,SAAS5I,EAAKyC,GAC7BpD,KAAKW,IAAMA,EACZX,KAAKoD,QAAUA,EAGhBmG,YAAWrJ,UAAU2F,OAAS,WAC5B,GAAInF,GAAOV,IAEXA,MAAKwJ,YAAcrK,EAAE,sBACrB,IAAIsK,IAAWjL,OAAOU,aAAec,KAAKwJ,YAAYE,cAAc,EAChEC,GAAWnL,OAAOc,cAAgBU,KAAKwJ,YAAYI,eAAe,CAEtE5J,MAAKwJ,YAAY3C,OAGjB7G,KAAKwJ,YAAYK,KAAKC,IAAOH,EAASI,KAAQN,GAE9C,IAAIO,GAAmBxL,OAAOsB,UAAY,WAAa,OAEvDE,MAAKwJ,YAAYlG,KAAK0G,EAAkB,SAASrI,GAC/C,GAAIsI,GAAS9K,EAAEwC,EAAEuI,cACjBD,GAAOE,QAAQ,KACfzJ,EAAK0C,QAAQe,QAAQ,wBAIzBoF,WAAWrJ,UAAUoB,OAAS,WAC5BtB,KAAKwJ,YAAYlI,SAInB,IAAI8I,QAAS,YACbA,QAAOlK,UAAU6E,WAAa,WAC5B,GAAIsF,GAAc,GAAI7G,aAClBjD,EAAW,GAAIR,UAGhBqD,IACJM,GAAEC,OAAOP,EAASQ,SAASC,QAE1BzE,OAAOiF,GAAKjF,OAAOiF,IAAMsE,MAEzB,IAAIjB,GAAI,GAAI9C,WAAUxF,OAAOZ,OAAQ+B,EAAU6C,GAC3CkH,EAAK,GAAIf,YAAWnG,GACpBmH,EAAM,GAAIlK,oBAAmBqH,EAAG2C,EAAa9J,EAAUnB,OAAOZ,OAAQ8L,EAExD,IAAIpH,0BAAyBqH,EAAKnH,GAASC,MAE7DiH,GAAG3J,IAAM4J,EAAI5J,GAEb,IAAI6J,GAAQ,GAAIpG,aAAYhF,OAAOiF,GAAIgG,EACvCG,GAAMnH,OACNmH,EAAMhG,SAAS+F,EAAI5J,KAEnBvB,OAAOiL,YAAcA,EAErBC,EAAGzE,SACH6B,EAAE7B","file":"shmile-ui.js","sourcesContent":["/**\n * A bucket of utility methods.\n */\n var CameraUtils = function() {};\n\n/**\n * Play the snap effect.\n *\n * @param {PhotoView} photoView\n * @param {Integer} idx\n *   The frame index to place the updated image.\n * @param {Function} cheeseCb\n *   Code to execute after \"Cheese\" is displayed.\n *   Typically, this wraps the command to fire the shutter.\n */\nCameraUtils.snap = function(photoView, idx, cheeseCb) {\n  photoView.zoomFrame(idx, 'in');\n  // These guys need to be promises.\n  photoView.modalMessage('Ready?', Config.ready_delay, 200, function() {\n    photoView.modalMessage(\"3\", 1000, 200, function() {\n      photoView.modalMessage(\"2\", 1000, 200,  function() {\n        photoView.modalMessage(\"1\", 1000, 200, function() {\n          cheeseCb();\n        });\n      });\n    });\n  });\n}\n\n/**\n * Given a max w and h bounds, return the dimensions\n * of the largest 4x6 rect that will fit within.\n */\nCameraUtils.scale4x6 = function(maxw, maxh) {\n    var s0 = 6/4; // width / height\n    var s1 = maxw/maxh;\n\n    // Then the width is longer. Use the shorter side (height)\n    if (s0 <= s1) {\n        return {w: maxh * 6/4, h: maxh};\n    } else {\n        return {w: maxw, h: maxw * 4/6}\n    }\n}\n\nvar Config = {\n  photo_margin: 50, // Margin for the composite photo per side\n  window_width: $(window).width(),\n  window_height: $(window).height() - 10,\n  overlay_delay: 2000,\n  next_delay: 10000,\n  cheese_delay: 400,\n  flash_duration: 1000,\n  ready_delay: 2000,\n  nice_delay: 5000,\n\n  // The amount of time we should pause between each frame shutter\n  // I tend to bump this up when 1) photobooth participants want more\n  // time to review their photos between shots, and 2) when I'm shooting\n  // with external flash and the flash needs more time to recharge.\n  between_snap_delay: 1000,\n\n  // For usability enhancements on iPad, set this to \"true\"\n  is_mobile: false\n}\n\n/**\n * Describes the current state of the UI.\n */\nvar AppState = function() {\n  this.reset();\n};\n\nAppState.prototype.reset = function() {\n  this.current_frame_idx = 0;\n  this.zoomed = null;\n}\n\n\n/*\n * STATE MACHINE DEFINITION\n * Keep track of app state and logic.\n *\n * + loading\n *   - connected() -> ready\n * + ready\n *   - ui_button_pressed() (DOM button click) -> waiting_for_photo\n * + waiting_for_photo\n *   - photo_saved() -> review_photo\n * + review_photo\n *   - photo_updated() -> next_photo\n * + next_photo\n *   - continue_partial_set() -> waiting_for_photo\n *   - finish_set() -> ready\n *\n * @param [PhotoView]\n * @param [Socket]            The initialized Socket\n * @param [AppState] appState Global initialized state\n * @param [Config] config     The configuration options passed to the app\n */\nvar ShmileStateMachine = function(photoView, socket, appState, config, buttonView) {\n  this.photoView = photoView;\n  this.socket = socket;\n  this.appState = appState;\n  this.config = config;\n  this.buttonView = buttonView\n\n  var self = this;\n\n  this.fsm = StateMachine.create({\n    initial: 'loading',\n    events: [\n      { name: 'connected', from: 'loading', to: 'ready' },\n      { name: 'ui_button_pressed', from: 'ready', to: 'waiting_for_photo' },\n      { name: 'photo_saved', from: 'waiting_for_photo', to: 'review_photo' },\n      { name: 'photo_updated', from: 'review_photo', to: 'next_photo' },\n      { name: 'continue_partial_set', from: 'next_photo', to: 'waiting_for_photo' },\n      { name: 'finish_set', from: 'next_photo', to: 'review_composited' },\n      { name: 'next_set', from: 'review_composited', to: 'ready'}\n    ],\n    callbacks: {\n      onconnected: function() {\n        self.photoView.animate('in', function() {\n          self.buttonView.fadeIn();\n        });\n      },\n      onenterready: function() {\n        self.photoView.resetState();\n      },\n      onleaveready: function() {\n      },\n      onenterwaiting_for_photo: function(e) {\n        cheeseCb = function() {\n          self.photoView.modalMessage('Cheese!', self.config.cheese_delay);\n          self.photoView.flashStart();\n          self.socket.emit('snap', true);\n        }\n        CameraUtils.snap(self.photoView,\n\t\t\t\t\t\t\t\t\t\t\t\t self.appState.current_frame_idx,\n\t\t\t\t\t\t\t\t\t\t\t\t cheeseCb);\n      },\n      onphoto_saved: function(e, f, t, data) {\n        // update UI\n        // By the time we get here, the idx has already been updated!!\n        self.photoView.flashEnd();\n        self.photoView.updatePhotoSet(data.web_url, self.appState.current_frame_idx, function() {\n          setTimeout(function() {\n            self.fsm.photo_updated();\n          }, self.config.between_snap_delay)\n        });\n      },\n      onphoto_updated: function(e, f, t) {\n        self.photoView.flashEnd();\n        // We're done with the full set.\n        if (self.appState.current_frame_idx == 3) {\n          self.fsm.finish_set();\n        }\n        // Move the frame index up to the next frame to update.\n        else {\n          self.appState.current_frame_idx = (self.appState.current_frame_idx + 1) % 4\n          self.fsm.continue_partial_set();\n        }\n      },\n      onenterreview_composited: function(e, f, t) {\n        self.socket.emit('composite');\n        self.photoView.showOverlay(true);\n        setTimeout(function() {\n          self.fsm.next_set()\n        }, self.config.next_delay);\n      },\n      onleavereview_composited: function(e, f, t) {\n        // Clean up\n        self.photoView.animate('out');\n        self.photoView.modalMessage('Nice!', self.config.nice_delay, 200, function() {\n          self.photoView.slideInNext();\n        });\n      },\n      onchangestate: function(e, f, t) {\n        console.log('fsm received event '+ e +', changing state from ' + f + ' to ' + t)\n      }\n    }\n  });\n}\n\n/**\n * Maps channel events to state machine events.\n */\nvar StateMachineEventHandler = function(stateMachine, channel) {\n\tthis.stateMachine = stateMachine;\n\tthis.channel = channel;\n}\n\nStateMachineEventHandler.prototype.init = function() {\n\tvar self = this;\n\tthis.channel.bind('ui_button_pressed', function() {\n\t\tself.stateMachine.fsm.ui_button_pressed();\n\t});\n}\n\n\n/**\n * Proxy object that allows the late initialization of the socket, if one\n * exists at all. In instances where we never initialize the socket, we allow\n * for a fake Socket object using a Backbone Event channel.\n */\nvar SocketProxy = function() {\n  this.socket = null;\n  this.fakeSocket = {};\n  _.extend(this.fakeSocket, Backbone.Events)\n}\n\nSocketProxy.prototype.lateInitialize = function(socket) {\n  this.socket = socket;\n}\n\nSocketProxy.prototype.on = function(evt, cb) {\n  if (this.socket === null) {\n    console.log(\"SocketProxy 'on' delegating to fakeSocket\")\n    this.fakeSocket.on(evt, cb)\n    return\n  }\n  this.socket.on(evt, cb);\n}\n\nSocketProxy.prototype.emit = function(msg, data) {\n  if (this.socket === null) {\n    console.log(\"SocketProxy 'emit' delegating to fakeSocket\")\n    this.fakeSocket.trigger(msg, function() {\n      console.log(data)\n    });\n    return\n  }\n  this.socket.emit(msg, data);\n}\n\n/**\n * Responsible for initializing the connection to socket.io.\n * @param io [Socket]\n * @param fsm [StateMachine]\n */\nvar SocketLayer = function(io, proxy) {\n  this.io = io;\n  this.proxy = proxy;\n}\n\n/**\n * Attempt a connection to socket.io server.\n * If this fails, will no-op and silently continue.\n */\nSocketLayer.prototype.init = function() {\n  try {\n    this.socket = this.io.connect(\"/\");\n    this.proxy.lateInitialize(this.socket);\n  } catch(e) {\n    console.log(\"Error initializing socket connection: \" + e);\n  }\n  return this;\n}\n\n/**\n * Register bindings and callbacks.\n */\nSocketLayer.prototype.register = function(fsm) {\n  this.fsm = fsm;\n  var self = this;\n\n  this.proxy.on('message', function(data) {\n    console.log('message evt: data is:' + data);\n  });\n\n  this.proxy.on('connect', function() {\n    console.log('connected evt');\n    self.fsm.connected();\n  });\n\n  this.proxy.on('camera_snapped', function() {\n    console.log('camera_snapped evt');\n    //fsm.camera_snapped();\n  })\n\n  this.proxy.on('photo_saved', function(data) {\n    console.log('photo_saved evt: ' + data.filename);\n    self.fsm.photo_saved(data);\n  });\n}\n\nvar PhotoView = Backbone.View.extend({\n  id: \"#viewport\",\n\n  initialize: function(config, state) {\n    this.config = config;\n    this.canvas = new Raphael('viewport', this.config.window_width, this.config.window_height);\n    this.frames = this.canvas.set(); // List of SVG black rects\n    this.images = this.canvas.set(); // List of SVG images\n    this.all = this.canvas.set();\n    this.overlayImage = null;\n    this.photoBorder = 0;\n    this.compositeDim = null;\n    this.frameDim = null;\n    this.compositeOrigin = null;\n    this.compositeCenter = null;\n    this.state = state;\n  },\n\n  render: function() {\n    var w = this.config.window_width - this.config.photo_margin;\n    var h = this.config.window_height - this.config.photo_margin;\n    this.compositeDim = CameraUtils.scale4x6(w, h);\n    this.compositeOrigin = {\n        x: (this.config.window_width - this.compositeDim.w) / 2,\n        y: (this.config.window_height - this.compositeDim.h) / 2\n    };\n    this.compositeCenter = {\n        x: this.compositeOrigin.x + (this.compositeDim.w/2),\n        y: this.compositeOrigin.y + (this.compositeDim.h/2)\n    }\n    var r = this.canvas.rect(this.compositeOrigin.x, this.compositeOrigin.y, this.compositeDim.w, this.compositeDim.h);\n\n    r.attr({'fill': 'white'});\n\n    this.all.push(r);\n\n    // Scale the photo padding too\n    this.photoBorder = this.compositeDim.w / 50;\n\n    //upper x\n    var frame_x = this.compositeOrigin.x + this.photoBorder;\n    var frame_y = this.compositeOrigin.y + this.photoBorder;\n    this.frameDim = {\n        w: (this.compositeDim.w - (3*this.photoBorder))/2,\n        h: (this.compositeDim.h - (3*this.photoBorder))/2\n    };\n    var frame = this.canvas.rect(frame_x, frame_y, this.frameDim.w, this.frameDim.h);\n    frame.attr({'fill': 'black'});\n    var img = this.canvas.image(null, frame_x, frame_y, this.frameDim.w, this.frameDim.h);\n\n    this.images.push(img);\n    this.frames.push(frame);\n    this.all.push(img);\n    this.all.push(frame);\n\n    frame = frame.clone();\n    img = img.clone();\n    frame.translate(this.frameDim.w + this.photoBorder, 0);\n    img.translate(this.frameDim.w + this.photoBorder, 0);\n    this.frames.push(frame);\n    this.images.push(img);\n    this.all.push(frame);\n    this.all.push(img);\n\n    frame = frame.clone();\n    img = img.clone();\n    frame.translate(-(this.frameDim.w + this.photoBorder), this.frameDim.h + this.photoBorder);\n    img.translate(-(this.frameDim.w + this.photoBorder), this.frameDim.h + this.photoBorder);\n    this.frames.push(frame);\n    this.images.push(img);\n    this.all.push(frame);\n    this.all.push(img);\n\n    frame = frame.clone();\n    img = img.clone();\n    frame.translate(this.frameDim.w + this.photoBorder, 0);\n    img.translate(this.frameDim.w + this.photoBorder, 0);\n    this.frames.push(frame);\n    this.images.push(img);\n    this.all.push(frame);\n    this.all.push(img);\n\n    // Draw the PNG logo overlay.\n    var o = this.canvas.image(\n        '/images/overlay.png',\n        this.compositeOrigin.x,\n        this.compositeOrigin.y,\n        this.compositeDim.w,\n        this.compositeDim.h);\n    this.all.push(o);\n    this.overlayImage = o;\n\n    // Hide everything and move out of sight.\n    this.all.hide();\n    this.all.translate(-this.config.window_width, 0);\n  },\n\n  toString: function() {\n    ret = [];\n    ret.push(\"Size of 'all' set: \" + this.all.length);\n    ret.push(\"Size of 'frames' set: \" + this.frames.length);\n    ret.push(\"Composite photo is: \" + this.all[0].attr('width') + 'x' + this.all[0].attr('height'));\n    ret.push(\"Frame photo is: \" + this.frameDim.w + 'x' + this.frameDim.h);\n    return ret.join('\\n');\n  },\n\n  /**\n   * Updates the image at the set location.\n   * @param {String} img_src\n   *   The URL of the image resource the browser should fetch and display\n   * @param {Integer} idx\n   *   Index of frame to update\n   * @param cb\n   *   The callback to be executed when the UI has finished updating and zooming out.\n   */\n  updatePhotoSet: function(img_src, idx, cb) {\n    var view = this;\n    var imgEl = view.images[idx];\n    var frameEl = view.frames[idx];\n\n    imgEl.attr({'src': img_src, 'opacity': 0});\n    imgEl.show();\n\n    var afterShowPhoto = function () {\n      // We've found and revealed the photo, now hide the old black rect and zoom out\n      frameEl.hide();\n      p.zoomFrame(idx, 'out', cb);\n    }\n    imgEl.animate({'opacity': 1}, 200, afterShowPhoto);\n  },\n\n  /**\n   * For in: assume the view has been rendered and reset to initial state and moved out of sight.\n   * Slide in the composite image.\n   * For out: assume the composite image is centered. Move out of sight and hide.\n   */\n  animate: function(dir, cb) {\n    if (dir === 'in') {\n      this.all.show();\n      this.images.hide();\n      this.overlayImage.hide();\n      this.all.animate({\n        'translation': this.config.window_width+\",0\"\n      }, 1000, \"<>\", cb);\n    } else if (dir === 'out') {\n      this.all.animate({\n        'translation': this.config.window_width+\",0\"\n      }, 1000, \"<>\", cb);\n    }\n  },\n\n  /**\n   * zoomFrame zooms into the indicated frame.\n   * Call it once to zoom in, call it again to zoom out.\n   *\n   * @param idx Frame index\n   *   Expect zoomFrame(1) to be matched immediately by zoomFrame(1)\n   * frame: 0 (upper left), 1 (upper-right), 2 (lower-left), 3 (lower-right)\n   * @param dir 'in' or 'out'\n   *   Zoom in or out\n   * @param onfinish\n   *   Callback executed when the animation is finished.\n   *\n   * Depends on the presence of the .zoomed object to store zoom info.\n   */\n  zoomFrame: function(idx, dir, onfinish) {\n      var view = this;\n      var composite = this.all[idx];\n\n      var frame = this.frames[idx];\n      var frameX = frame.attr('x');\n      var frameW = frame.attr('width');\n      var frameY = frame.attr('y');\n      var frameH = frame.attr('height');\n      var centerX = frameX + frameW/2;\n      var centerY = frameY + frameH/2;\n\n      var animSpeed = 700;\n\n      // delta to translate to.\n      var dx = this.compositeCenter.x - centerX;\n      var dy = this.compositeCenter.y - centerY;\n      var scaleFactor = this.compositeDim.w / this.frameDim.w;\n\n      if (dir === \"out\" && this.state.zoomed) {\n          scaleFactor = 1;\n          dx = -this.state.zoomed.dx;\n          dy = -this.state.zoomed.dy;\n          view.all.animate({\n              'scale': [1, 1, view.compositeCenter.x, view.compositeCenter.y].join(','),\n          }, animSpeed, 'bounce', function() {\n              view.all.animate({\n                  'translation': dx+','+dy\n              }, animSpeed, '<>', onfinish)\n          });\n          // Clear the zoom data.\n          this.state.zoomed = null;\n      } else if (dir !== \"out\") {\n          view.all.animate({\n              'translation': dx+','+dy\n          }, animSpeed, '<>', function() {\n              view.all.animate({\n                  'scale': [scaleFactor, scaleFactor, view.compositeCenter.x, view.compositeCenter.y].join(','),\n              }, animSpeed, 'bounce', onfinish)\n          });\n          // Store the zoom data for next zoom.\n          this.state.zoomed = {\n              dx: dx,\n              dy: dy,\n              scaleFactor: scaleFactor\n          };\n      }\n  },\n\n  /**\n   * Reset visibility, location of composite image for next round.\n   */\n  slideInNext: function() {\n      this.resetState();\n      this.modalMessage('Next!');\n      this.all.hide();\n      this.all.translate(-this.config.window_width * 2, 0);\n      this.animate('in', function() {\n        $('#start-button').fadeIn();\n      });\n  },\n\n  /**\n   * Resets the state variables.\n   */\n  resetState: function () {\n    this.state.reset();\n  },\n\n  /**\n   * Faux camera flash\n   */\n  flashEffect: function(duration) {\n    if (duration === undefined) { duration = 200; }\n    var rect = this.canvas.rect(0, 0, this.config.window_width, this.config.window_height);\n    rect.attr({'fill': 'white', 'opacity': 0});\n    rect.animate({'opacity': 1}, duration, \">\", function() {\n      rect.animate({'opacity': 0}, duration, \"<\");\n      rect.remove();\n    })\n  },\n\n  flashStart: function(duration) {\n    if (duration === undefined) { duration = 200; }\n    this.rect = this.canvas.rect(0, 0, this.config.window_width, this.config.window_height);\n    this.rect.attr({'fill': 'white', 'opacity': 0});\n    this.rect.animate({'opacity': 1}, duration, \">\")\n  },\n\n  flashEnd: function(duration) {\n    if (duration === undefined) { duration = 200; }\n    var self = this;\n    this.rect.animate({'opacity': 0}, duration, \"<\", function() {\n      self.remove();\n    });\n  },\n\n  /**\n   * Draws a modal with some text.\n   */\n  modalMessage: function(text, persistTime, animateSpeed, cb) {\n      if (animateSpeed === undefined) { var animateSpeed = 200; }\n      if (persistTime === undefined) { var persistTime = 500; }\n\n      var sideLength = this.config.window_height * 0.3;\n      var x = (this.config.window_width - sideLength)/2;\n      var y = (this.config.window_height - sideLength)/2;\n      var all = this.canvas.set();\n      var r = this.canvas.rect(x, y,\n          sideLength,\n          sideLength,\n          15);\n      r.attr({'fill': '#222',\n              'fill-opacity': 0.7,\n              'stroke-color': 'white'});\n      all.push(r);\n      var txt = this.canvas.text(x + sideLength/2, y + sideLength/2, text);\n      txt.attr({'fill': 'white',\n          'font-size': '50',\n          'font-weight': 'bold'\n      });\n      all.push(txt);\n      all.attr({'opacity': 0});\n      all.animate({\n          'opacity': 1,\n          'scale': '1.5,1.5',\n          'font-size': '70'\n      }, animateSpeed, '>');\n\n      // Timer to delete self nodes.\n      var t = setTimeout(function(all) {\n          // Delete nodes\n          txt.remove();\n          r.remove();\n          if (cb) cb();\n      }, persistTime, all);\n  },\n\n  /**\n   * Applies the final image overlay to the composite image.\n   * This will usually contain the wedding logo: 24-bit transparent PNG\n   */\n  showOverlay: function(animate) {\n      this.overlayImage.show();\n      if (animate) {\n          //this.overlayImage.attr({'opacity':0});\n        this.overlayImage.animate({'opacity':1}, this.config.overlay_delay);\n      }\n  },\n\n  /**\n   * Removes the overlay\n   */\n  hideOverlay: function(animate) {\n    var view = this;\n    if (animate) {\n      this.overlayImage.animate({'opacity':0}, this.config.overlay_delay, function() {\n        view.overlayImage.hide();\n      });\n    } else {\n      this.overlayImage.hide();\n    }\n  }\n});\n\nvar ButtonView = function(fsm, channel) {\n  this.fsm = fsm;\n\tthis.channel = channel;\n}\n\nButtonView.prototype.render = function() {\n  var self = this;\n  // init code\n  this.startButton = $('button#start-button');\n  var buttonX = (Config.window_width - this.startButton.outerWidth())/2;\n  var buttonY = (Config.window_height - this.startButton.outerHeight())/2;\n\n  this.startButton.hide();\n\n  // Position the start button in the center\n  this.startButton.css({'top': buttonY, 'left': buttonX});\n\n  var buttonTriggerEvt = Config.is_mobile ? \"touchend\" : \"click\";\n\n  this.startButton.bind(buttonTriggerEvt, function(e) {\n    var button = $(e.currentTarget);\n    button.fadeOut(1000);\n    self.channel.trigger('ui_button_pressed');\n  });\n}\n\nButtonView.prototype.fadeIn = function() {\n  this.startButton.fadeIn();\n}\n\n// Everything required to set up the app.\nvar Shmile = function() {};\nShmile.prototype.initialize = function() {\n  var socketProxy = new SocketProxy();\n  var appState = new AppState();\n\n\t// Inter-object communication layer.\n\tvar channel = {};\n\t_.extend(channel, Backbone.Events);\n\n  window.io = window.io || undefined;\n\n  var p = new PhotoView(window.Config, appState, channel);\n  var bv = new ButtonView(channel);\n  var ssm = new ShmileStateMachine(p, socketProxy, appState, window.Config, bv)\n\n\tvar eventHandler = new StateMachineEventHandler(ssm, channel).init();\n\n  bv.fsm = ssm.fsm\n\n  var layer = new SocketLayer(window.io, socketProxy)\n  layer.init();\n  layer.register(ssm.fsm);\n\n  window.socketProxy = socketProxy\n\n  bv.render();\n  p.render();\n};\n\n"],"sourceRoot":"/source/"}