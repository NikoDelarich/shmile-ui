{"version":3,"sources":["shmile-ui.js"],"names":["CameraUtils","snap","idx","cheeseCb","p","zoomFrame","modalMessage","Config","ready_delay","scale4x6","maxw","maxh","w","h","scale4x1","scale3x8","scale","s0","photo_margin","window_width","$","window","width","window_height","height","overlay_delay","next_delay","cheese_delay","flash_duration","nice_delay","between_snap_delay","is_mobile","AppState","this","reset","prototype","current_frame_idx","zoomed","ShmileStateMachine","photoView","socket","appState","config","buttonView","snackbar","self","buttonPrint","shouldSendNotPrinting","on","optionalPrinting","console","log","fsm","show_print_message","setTimeout","show_message","emit","print_set","StateMachine","create","initial","events","name","from","to","callbacks","onconnected","animate","fadeIn","onenterready","resetState","onleaveready","onenterwaiting_for_photo","e","flashStart","onphoto_saved","f","t","data","flashEnd","updatePhotoSet","web_url","photo_updated","onphoto_updated","pictures","getPicturesTotal","finish_set","continue_partial_set","onenterreview_composited","showOverlay","onenterprinting","clearTimeout","onentershow_goodbye_message","next_set","hideMe","onenterprint_message","showMe","onleaveshow_goodbye_message","slideInNext","onchangestate","SocketProxy","fakeSocket","_","extend","Backbone","Events","lateInitialize","evt","cb","msg","trigger","SocketLayer","io","proxy","init","connect","register","connected","filename","photo_saved","PhotoView","View","id","initialize","state","paper","Raphael","frames","set","images","all","overlayImage","compositeDim","compositeOrigin","compositeCenter","render","template","translationTotal","dx","dy","photoViewLayout","finalSizeRatio","x","y","r","rect","attr","fill","push","stuff","frameDim","setOverlay","translate","toString","ret","length","join","img_src","view","imgEl","frameEl","src","opacity","show","hide","dir","translation","onfinish","frame","frameX","frameW","frameY","frameH","centerX","centerY","totalPictures","scaleFactor","calculateOutTranslation","shouldRestoreOutState","flashEffect","duration","undefined","remove","text","persistTime","animateSpeed","sideLength","fill-opacity","stroke-color","txt","font-size","font-weight","hideOverlay","o","image","ButtonView","startButton","buttonX","outerWidth","buttonY","outerHeight","css","top","left","buttonTriggerEvt","bind","currentTarget","fadeOut","document","ui_button_pressed","ready","socketProxy","layer","bv","Snackbar","ssm","location","reload","getElementById","pressed","classClass","className","PortraitOneByFour","photoBorder","frame_x","frame_y","_frame_w","img","i","clone","LandscapeTwoByTwo","LandscapeOneByThree","size","frameSize","frameSpacing","spacing","SnapOneByFour","Snap","viewBox","select","append","SVGElement","getTransformToElement","elem","getScreenCTM","inverse","multiply","plugin","Element","Paper","global","altMoveDrag","xxdx","xxdy","ax","ay","cursorPoint","getCursorPoint","pt","node","createSVGPoint","localPt","globalToLocal","transform","toTransformString","altStartDrag","ev","getBBox","localMatrix","getCenter","bbox","cx","cy","getSize","getPos","getTransformRelative","relativeObj","type","absolute","xadjust","yadjust","movex","movey","c","elpos","elsize","movepos","y2","rsize","x2","rpos","rbox","getCenterPoint","center","matrixTransform","globalPoint","zoomToFit","centerPoint","paperPoint","ztf","pt1","altDrag","drag","load","el","overlay","b","mina","bounce","easeInOut","removeImages","createOverlayImage","StripOneByThree","skipFrame"],"mappings":"AAGC,IAAIA,YAAc,aAUnBA,YAAYC,KAAO,SAASC,EAAKC,GAC/BC,EAAEC,UAAUH,EAAK,MAEjBE,EAAEE,aAAa,SAAUC,OAAOC,YAAa,IAAK,WAChDJ,EAAEE,aAAa,IAAK,IAAM,IAAK,WAC7BF,EAAEE,aAAa,IAAK,IAAM,IAAM,WAC9BF,EAAEE,aAAa,IAAK,IAAM,IAAK,WAC7BH,aAWVH,YAAYS,SAAW,SAASC,EAAMC,GAKlC,OAJS,KACAD,EAAKC,GAIFC,EAAU,EAAPD,EAAS,EAAGE,EAAGF,IAElBC,EAAGF,EAAMG,EAAU,EAAPH,EAAS,IAIrCV,YAAYc,SAAW,SAASJ,EAAMC,GAKlC,OAJS,KACAD,EAAKC,GAIFC,EAAU,EAAPD,EAAS,EAAI,GAAKE,EAAGF,IAExBC,EAAGF,EAAMG,EAAU,EAAPH,EAAS,EAAI,KAQzCV,YAAYe,SAAW,SAASL,EAAMC,GAKlC,OAJS,EAAE,GACFD,EAAKC,GAIFC,EAAGD,GALN,EAAE,GAKeE,EAAGF,IAEjBC,EAAGF,EAAMG,EAAU,KAAPH,IAI5BV,YAAYgB,MAAQ,SAASN,EAAMC,EAAMM,GAKrC,OAAIA,GAHKP,EAAKC,GAIFC,EAAGD,EAAOM,EAAIJ,EAAGF,IAEjBC,EAAGF,EAAMG,EAAGH,GAAQ,EAAEO,KAItC,IAAIV,QACFW,aAAc,GACdC,aAAcC,EAAEC,QAAQC,QACxBC,cAAeH,EAAEC,QAAQG,SAAW,GACpCC,cAAe,IACfC,WAAY,IACZC,aAAc,IACdC,eAAgB,IAChBpB,YAAa,IACbqB,WAAY,IAMZC,mBAAoB,IAGpBC,WAAW,GAMTC,SAAW,WACbC,KAAKC,SAGPF,SAASG,UAAUD,MAAQ,WACzBD,KAAKG,kBAAoB,EACzBH,KAAKI,OAAS,MAyBhB,IAAIC,mBAAqB,SAASC,EAAWC,EAAQC,EAAUC,EAAQC,EAAYC,GACjFX,KAAKM,UAAYA,EACjBN,KAAKO,OAASA,EACdP,KAAKQ,SAAWA,EAChBR,KAAKS,OAASA,EACdT,KAAKU,WAAaA,EAClBV,KAAKW,SAAWA,EAEhB,IAAIC,EAAOZ,KAEXA,KAAKa,YAAc,KACnBb,KAAKc,uBAAwB,EAE7BF,EAAKL,OAAOQ,GAAG,kBAAmB,SAASC,GACzCC,QAAQC,IAAI,uDAAyDF,GAC/DA,GACFJ,EAAKE,uBAAwB,EAC7BF,EAAKO,IAAIC,qBAETR,EAAKC,YAAcQ,WAAW,WAE5BT,EAAKO,IAAIG,gBACRV,EAAKH,OAAOhB,cAEfmB,EAAKL,OAAOgB,KAAK,SACjBF,WAAW,WACTT,EAAKO,IAAIK,aACRZ,EAAKH,OAAOhB,eAGrBmB,EAAKL,OAAOQ,GAAG,oBAAqB,WAClCM,WAAW,WACTT,EAAKO,IAAIG,gBACRV,EAAKH,OAAOhB,cAEjBmB,EAAKL,OAAOQ,GAAG,QAAS,WACtBH,EAAKO,IAAIK,cAGXxB,KAAKmB,IAAMM,aAAaC,QACtBC,QAAS,UACTC,SACIC,KAAM,YAAaC,KAAM,UAAWC,GAAI,UACxCF,KAAM,oBAAqBC,KAAM,QAASC,GAAI,sBAC9CF,KAAM,cAAeC,KAAM,oBAAqBC,GAAI,iBACpDF,KAAM,gBAAiBC,KAAM,eAAgBC,GAAI,eACjDF,KAAM,uBAAwBC,KAAM,aAAcC,GAAI,sBACtDF,KAAM,aAAcC,KAAM,aAAcC,GAAI,sBAC5CF,KAAM,qBAAsBC,KAAM,oBAAqBC,GAAI,kBAC3DF,KAAM,YAAaC,MAAO,gBAAiB,qBAAsBC,GAAI,aAErEF,KAAM,eAAgBC,KAAM,WAAYC,GAAI,uBAC5CF,KAAM,eAAgBC,MAAO,oBAAqB,gBAAiB,WAAY,sBAAuBC,GAAI,yBAC1GF,KAAM,WAAYC,KAAM,uBAAwBC,GAAI,UAExDC,WACEC,YAAa,WACXhB,QAAQC,IAAI,eACZN,EAAKN,UAAU4B,QAAQ,KAAM,WAC3BtB,EAAKF,WAAWyB,YAGpBC,aAAc,WACZxB,EAAKE,uBAAwB,EAC7BF,EAAKN,UAAU+B,cAEjBC,aAAc,aAEdC,yBAA0B,SAASC,GACjCtE,SAAW,WACT0C,EAAKN,UAAUjC,aAAa,UAAWuC,EAAKH,OAAOf,cACnDkB,EAAKN,UAAUmC,aACf7B,EAAKL,OAAOgB,KAAK,QAAQ,IAE3BxD,YAAYC,KAAK4C,EAAKJ,SAASL,kBAAmBjC,WAEpDwE,cAAe,SAASF,EAAGG,EAAGC,EAAGC,GAG/BjC,EAAKN,UAAUwC,WACflC,EAAKN,UAAUyC,eAAeF,EAAKG,QAASpC,EAAKJ,SAASL,kBAAmB,WAC3EkB,WAAW,WACTT,EAAKO,IAAI8B,iBACRrC,EAAKH,OAAOZ,uBAGnBqD,gBAAiB,SAASV,EAAGG,EAAGC,GAC9BhC,EAAKN,UAAUwC,WAEf,IAAIK,EAAWvC,EAAKN,UAAU8C,mBAC1BxC,EAAKJ,SAASL,mBAAqBgD,EAAW,EAChDvC,EAAKO,IAAIkC,cAITzC,EAAKJ,SAASL,mBAAqBS,EAAKJ,SAASL,kBAAoB,GAAKgD,EAC1EvC,EAAKO,IAAImC,yBAGbC,yBAA0B,SAASf,EAAGG,EAAGC,GACvChC,EAAKL,OAAOgB,KAAK,aACjBX,EAAKN,UAAUkD,aAAY,IAE7BC,gBAAiB,SAASjB,EAAGG,EAAGC,GAC9Bc,aAAa9C,EAAKC,aAClBD,EAAKE,uBAAwB,EAC7BO,WAAW,WACTT,EAAKO,IAAIG,gBACRV,EAAKH,OAAOZ,qBAEjB8D,4BAA6B,SAASnB,EAAGG,EAAGC,GAE1ChC,EAAKO,IAAIyC,WACThD,EAAKD,SAASkD,SACVjD,EAAKE,uBACPF,EAAKL,OAAOgB,KAAK,iBAGrBuC,qBAAsB,SAAStB,EAAGG,EAAGC,GACnChC,EAAKD,SAASoD,UAEhBC,4BAA6B,SAASxB,EAAGG,EAAGC,GAE1ChC,EAAKN,UAAU4B,QAAQ,OACvBtB,EAAKN,UAAUjC,aAAa,QAASuC,EAAKH,OAAOb,WAAY,IAAK,WAChEgB,EAAKN,UAAU2D,iBAGnBC,cAAe,SAAS1B,EAAGG,EAAGC,GAC5B3B,QAAQC,IAAI,sBAAuBsB,EAAG,yBAA2BG,EAAI,OAASC,QAWlFuB,YAAc,WAChBnE,KAAKO,OAAS,KACdP,KAAKoE,cACLC,EAAEC,OAAOtE,KAAKoE,WAAYG,SAASC,SAGrCL,YAAYjE,UAAUuE,eAAiB,SAASlE,GAC9CP,KAAKO,OAASA,GAGhB4D,YAAYjE,UAAUa,GAAK,SAAS2D,EAAKC,GACvC,GAAoB,OAAhB3E,KAAKO,OAGP,OAFAU,QAAQC,IAAI,kDACZlB,KAAKoE,WAAWrD,GAAG2D,EAAKC,GAG1B3E,KAAKO,OAAOQ,GAAG2D,EAAKC,IAGtBR,YAAYjE,UAAUqB,KAAO,SAASqD,EAAK/B,GACzC,GAAoB,OAAhB7C,KAAKO,OAKP,OAJAU,QAAQC,IAAI,oDACZlB,KAAKoE,WAAWS,QAAQD,EAAK,WAC3B3D,QAAQC,IAAI2B,KAIhB7C,KAAKO,OAAOgB,KAAKqD,EAAK/B,IAQxB,IAAIiC,YAAc,SAASC,EAAIC,GAC7BhF,KAAK+E,GAAKA,EACV/E,KAAKgF,MAAQA,GAOfF,YAAY5E,UAAU+E,KAAO,WAC3B,IACEjF,KAAKO,OAASP,KAAK+E,GAAGG,QAAQ,KAC9BlF,KAAKgF,MAAMP,eAAezE,KAAKO,QAC/B,MAAMiC,GACNvB,QAAQC,IAAI,yCAA2CsB,GAEzD,OAAOxC,MAMT8E,YAAY5E,UAAUiF,SAAW,SAAShE,GACxCF,QAAQC,IAAI,YACZlB,KAAKmB,IAAMA,EACX,IAAIP,EAAOZ,KAEXA,KAAKgF,MAAMjE,GAAG,UAAW,SAAS8B,GAChC5B,QAAQC,IAAI,wBAA0B2B,KAGxC7C,KAAKgF,MAAMjE,GAAG,UAAW,WACvBE,QAAQC,IAAI,iBACZN,EAAKO,IAAIiE,cAGXpF,KAAKgF,MAAMjE,GAAG,iBAAkB,WAC9BE,QAAQC,IAAI,wBAIdlB,KAAKgF,MAAMjE,GAAG,cAAe,SAAS8B,GACpC5B,QAAQC,IAAI,oBAAsB2B,EAAKwC,UACvCzE,EAAKO,IAAImE,YAAYzC,MAIzB,IAAI0C,UAAYhB,SAASiB,KAAKlB,QAC5BmB,GAAI,YAEJC,WAAY,SAASjF,EAAQkF,GAC3B3F,KAAKS,OAASA,EACdT,KAAK4F,MAAQ,IAAIC,QAAQ,WAAY7F,KAAKS,OAAOvB,aAAcc,KAAKS,OAAOnB,eAC3EU,KAAK8F,OAAS9F,KAAK4F,MAAMG,MACzB/F,KAAKgG,OAAShG,KAAK4F,MAAMG,MACzB/F,KAAKiG,IAAMjG,KAAK4F,MAAMG,MACtB/F,KAAKkG,aAAe,KACpBlG,KAAKmG,aAAe,KACpBnG,KAAKoG,gBAAkB,KACvBpG,KAAKqG,gBAAkB,KACvBrG,KAAK2F,MAAQA,GAGfW,OAAQ,SAASC,GACfvG,KAAKwG,kBAAoBC,GAAG,EAAGC,GAAG,GAClC1G,KAAK2G,gBAAkB,IAAIvH,OAAOmH,EAASjG,WAAWN,KAAKS,QAE3D,IAAI9B,EAAIqB,KAAKS,OAAOvB,aAAec,KAAKS,OAAOxB,aAC3CL,EAAIoB,KAAKS,OAAOnB,cAAgBU,KAAKS,OAAOxB,aAEhDe,KAAKmG,aAAepI,YAAYgB,MAAMJ,EAAGC,EAAGoB,KAAK2G,gBAAgBC,gBACjE5G,KAAKoG,iBACHS,GAAI7G,KAAKS,OAAOvB,aAAec,KAAKmG,aAAaxH,GAAK,EACtDmI,GAAI9G,KAAKS,OAAOnB,cAAgBU,KAAKmG,aAAavH,GAAK,GAEzDoB,KAAKqG,iBACHQ,EAAG7G,KAAKoG,gBAAgBS,EAAK7G,KAAKmG,aAAaxH,EAAE,EACjDmI,EAAG9G,KAAKoG,gBAAgBU,EAAK9G,KAAKmG,aAAavH,EAAE,GAEnD,IAAImI,EAAI/G,KAAK4F,MAAMoB,KAAKhH,KAAKoG,gBAAgBS,EAAG7G,KAAKoG,gBAAgBU,EAAG9G,KAAKmG,aAAaxH,EAAGqB,KAAKmG,aAAavH,GAE/GmI,EAAEE,MAAMC,KAAQ,UAEhBlH,KAAKiG,IAAIkB,KAAKJ,GAEd,IAAIK,GACFjB,aAAgBnG,KAAKmG,aACrBP,MAAS5F,KAAK4F,MACdQ,gBAAmBpG,KAAKoG,gBACxBN,OAAU9F,KAAK8F,OACfE,OAAUhG,KAAKgG,OACfC,IAAOjG,KAAKiG,KAGdjG,KAAKqH,SAAWrH,KAAK2G,gBAAgBL,OAAOc,GAC5CpH,KAAKsH,WAAWf,EAASL,cACzBlG,KAAKiG,IAAIsB,WAAWvH,KAAKS,OAAOvB,aAAc,IAGhDsI,SAAU,WAMR,OALAC,OACAA,IAAIN,KAAK,sBAAwBnH,KAAKiG,IAAIyB,QAC1CD,IAAIN,KAAK,yBAA2BnH,KAAK8F,OAAO4B,QAChDD,IAAIN,KAAK,uBAAyBnH,KAAKiG,IAAI,GAAGgB,KAAK,SAAW,IAAMjH,KAAKiG,IAAI,GAAGgB,KAAK,WACrFQ,IAAIN,KAAK,mBAAqBnH,KAAKqH,SAAS1I,EAAI,IAAMqB,KAAKqH,SAASzI,GAC7D6I,IAAIE,KAAK,OAYlB5E,eAAgB,SAAS6E,EAAS3J,EAAK0G,GACrC,IAAIkD,EAAO7H,KACP8H,EAAQD,EAAK7B,OAAO/H,GACpB8J,EAAUF,EAAK/B,OAAO7H,GAE1BgD,QAAQC,IAAI,SAAWjD,GAIvB6J,EAAMb,MAAMe,IAAOJ,EAASK,QAAW,IACvCH,EAAMI,OAONJ,EAAM5F,SAAS+F,QAAW,GAAI,IALT,WAEnBF,EAAQI,OACRhK,EAAEC,UAAUH,EAAK,MAAO0G,MAU5BzC,QAAS,SAASkG,EAAKzD,GACT,OAARyD,GACEpI,KAAKkG,cACPlG,KAAKkG,aAAaiC,OAEpBnI,KAAKiG,IAAI/D,SACPmG,YAAerI,KAAKS,OAAOvB,aAAa,MACvC,IAAM,KAAMyF,IACE,QAARyD,GACTpI,KAAKiG,IAAI/D,SACPmG,YAAerI,KAAKS,OAAOvB,aAAa,MACvC,IAAM,KAAMyF,IAmBnBvG,UAAW,SAASH,EAAKmK,EAAKE,GAC5B,GAAa,QAARF,GAAiBpI,KAAK2F,MAAMvF,QACpB,OAARgI,IAAiBpI,KAAK2F,MAAMvF,OAAS,CACxC,IAAIyH,EAAO7H,KACPuI,EAAQV,EAAK/B,OAAO7H,GAEpBuK,EAASD,EAAMtB,KAAK,KACpBwB,EAASF,EAAMtB,KAAK,SACpByB,EAASH,EAAMtB,KAAK,KACpB0B,EAASJ,EAAMtB,KAAK,UACpB2B,EAAUJ,EAASC,EAAO,EAC1BI,EAAUH,EAASC,EAAO,EAK1BlC,EAAKzG,KAAKqG,gBAAgBQ,EAAI+B,EAC9BlC,EAAK1G,KAAKqG,gBAAgBS,EAAI+B,EAElC,GAAY,QAART,GAAiBpI,KAAK2F,MAAMvF,OAE9ByH,EAAKrB,iBAAiBC,IAAMzG,KAAK2F,MAAMvF,OAAOqG,GAC9CoB,EAAKrB,iBAAiBE,IAAM1G,KAAK2F,MAAMvF,OAAOsG,GAC9CmB,EAAK5B,IAAI/D,SACPnD,OAAU,EAAG,EAAG8I,EAAKxB,gBAAgBQ,EAAGgB,EAAKxB,gBAAgBS,GAAGa,KAAK,MAXzD,IAYA,SACd,WACM1J,GAAO4J,EAAKlB,gBAAgBmC,cAAgB,EAC9CjB,EAAK5B,IAAI/D,SACPmG,YAAeR,EAAKrB,iBAAiBC,GAAG,IAAIoB,EAAKrB,iBAAiBE,IAhB1D,IAiBI,KAAM4B,GAEpBA,MAGJtI,KAAK2F,MAAMvF,OAAS,UACf,GAAY,QAARgI,EAAe,CACxB,IAAIW,EAAc/I,KAAKmG,aAAavH,EAAI+J,EACxCd,EAAK5B,IAAI/D,SACPmG,YAAe5B,EAAG,IAAIC,GA1BV,IA2BA,KAAM,WAClBmB,EAAK5B,IAAI/D,SACPnD,OAAUgK,EAAaA,EAAalB,EAAKxB,gBAAgBQ,EAAGgB,EAAKxB,gBAAgBS,GAAGa,KAAK,MA7B/E,IA8BE,SAAUW,KAG1BtI,KAAK2F,MAAMvF,QACTqG,GAAIA,EACJC,GAAIA,MAOZsC,wBAAyB,SAAS/K,EAAK0H,EAAO2C,GAC5C,IAAIT,EAAO7H,KAGP6H,EAAKoB,sBACPpB,EAAK5B,IAAI/D,SACPmG,cAAiB1C,EAAMc,IAAKd,EAAMe,IAAIiB,KAAK,MAJ/B,IAKA,KAAMW,IAEpBT,EAAKrB,iBAAiBC,IAAMd,EAAMvF,OAAOqG,GACzCoB,EAAKrB,iBAAiBE,IAAMf,EAAMvF,OAAOsG,GACrCzI,GAAO4J,EAAKiB,cAAgB,EAC9BjB,EAAK5B,IAAI/D,SACPmG,YAAeR,EAAKrB,iBAAiBC,GAAG,IAAIoB,EAAKrB,iBAAiBE,IAXxD,IAYE,KAAM4B,GAEpBA,MAQNrE,YAAa,WACTjE,KAAKqC,aACLrC,KAAK3B,aAAa,SAElB2B,KAAKgG,OAAOmC,OACZnI,KAAK8F,OAAOoC,OAEZlI,KAAKwG,iBAAiBC,GAAK,EAC3BzG,KAAKwG,iBAAiBE,GAAK,EAE3B1G,KAAKiG,IAAIsB,UAAsC,GAA3BvH,KAAKS,OAAOvB,aAAkB,GAElDc,KAAKkC,QAAQ,KAAM,WACjB/C,EAAE,iBAAiBgD,YAOzBE,WAAY,WACVrC,KAAK2F,MAAM1F,SAMbiJ,YAAa,SAASC,QACHC,IAAbD,IAA0BA,EAAW,KAEzC,IAAInC,EAAOhH,KAAK4F,MAAMoB,KAAK,EAAG,EAAGhH,KAAKS,OAAOvB,aAAcc,KAAKS,OAAOnB,eACvE0H,EAAKC,MAAMC,KAAQ,QAASe,QAAW,IACvCjB,EAAK9E,SAAS+F,QAAW,GAAIkB,EAAU,IAAK,WAC1CnC,EAAK9E,SAAS+F,QAAW,GAAIkB,EAAU,KACvCnC,EAAKqC,YAIT5G,WAAY,SAAS0G,QACFC,IAAbD,IAA0BA,EAAW,KAEzCnJ,KAAKgH,KAAOhH,KAAK4F,MAAMoB,KAAK,EAAG,EAAGhH,KAAKS,OAAOvB,aAAcc,KAAKS,OAAOnB,eACxEU,KAAKgH,KAAKC,MAAMC,KAAQ,QAASe,QAAW,IAC5CjI,KAAKgH,KAAK9E,SAAS+F,QAAW,GAAIkB,EAAU,MAG9CrG,SAAU,SAASqG,QACAC,IAAbD,IAA0BA,EAAW,KACzC,IAAIvI,EAAOZ,KACXA,KAAKgH,KAAK9E,SAAS+F,QAAW,GAAIkB,EAAU,IAAK,WAC/CvI,EAAKyI,YAOThL,aAAc,SAASiL,EAAMC,EAAaC,EAAc7E,GACpD,QAAqByE,IAAjBI,EAA8B,IAAIA,EAAe,IACrD,QAAoBJ,IAAhBG,EAA6B,IAAIA,EAAc,IAEnD,IAAIE,EAAyC,GAA5BzJ,KAAKS,OAAOnB,cACzBuH,GAAK7G,KAAKS,OAAOvB,aAAeuK,GAAY,EAC5C3C,GAAK9G,KAAKS,OAAOnB,cAAgBmK,GAAY,EAC7CxD,EAAMjG,KAAK4F,MAAMG,MACjBgB,EAAI/G,KAAK4F,MAAMoB,KAAKH,EAAGC,EAEvB2C,EACAA,EACA,IACJ1C,EAAEE,MAAMC,KAAQ,OACRwC,eAAgB,GAChBC,eAAgB,UACxB1D,EAAIkB,KAAKJ,GACT,IAAI6C,EAAM5J,KAAK4F,MAAM0D,KAAKzC,EAAI4C,EAAW,EAAG3C,EAAI2C,EAAW,EAAGH,GAC9DM,EAAI3C,MAAMC,KAAQ,QACd2C,YAAa,KACbC,cAAe,SAEnB7D,EAAIkB,KAAKyC,GACT3D,EAAIgB,MAAMgB,QAAW,IACrBhC,EAAI/D,SACA+F,QAAW,EACXlJ,MAAS,UACT8K,YAAa,MACdL,EAAc,KAGTnI,WAAW,SAAS4E,GAExB2D,EAAIP,SACJtC,EAAEsC,SACE1E,GAAIA,KACT4E,EAAatD,IAOpBzC,YAAa,SAAStB,GAClBlC,KAAKkG,aAAagC,OACdhG,GAEFlC,KAAKkG,aAAahE,SAAS+F,QAAU,GAAIjI,KAAKS,OAAOjB,gBAO3DuK,YAAa,SAAS7H,GACpB,IAAI2F,EAAO7H,KACPkC,EACFlC,KAAKkG,aAAahE,SAAS+F,QAAU,GAAIjI,KAAKS,OAAOjB,cAAe,WAClEqI,EAAK3B,aAAaiC,SAGpBnI,KAAKkG,aAAaiC,QAItBb,WAAY,SAASpB,GAEnB,IAAI8D,EAAIhK,KAAK4F,MAAMqE,MACjB/D,EACAlG,KAAKoG,gBAAgBS,EACrB7G,KAAKoG,gBAAgBU,EACrB9G,KAAKmG,aAAaxH,EAClBqB,KAAKmG,aAAavH,GAEfoB,KAAKkG,cACRlG,KAAKiG,IAAIkB,KAAK6C,GAGhBA,EAAE7B,OACFnI,KAAKkG,aAAe8D,GAGtB5G,iBAAkB,WAChB,OAAOpD,KAAK2G,gBAAgBmC,iBAM5BoB,WAAa,SAAS/I,GACxBnB,KAAKmB,IAAMA,GAGb+I,WAAWhK,UAAUoG,OAAS,WAC5B,IAAI1F,EAAOZ,KAEXA,KAAKmK,YAAchL,EAAE,uBACrB,IAAIiL,GAAW9L,OAAOY,aAAec,KAAKmK,YAAYE,cAAc,EAChEC,GAAWhM,OAAOgB,cAAgBU,KAAKmK,YAAYI,eAAe,EAEtEvK,KAAKmK,YAAYhC,OAGjBnI,KAAKmK,YAAYK,KAAKC,IAAOH,EAASI,KAAQN,IAE9C,IAAIO,EAAmBrM,OAAOwB,UAAY,WAAa,QAEvDE,KAAKmK,YAAYS,KAAKD,EAAkB,SAASnI,GAClCrD,EAAEqD,EAAEqI,eACVC,QAAQ,KACf3L,EAAE4L,UAAUlG,QAAQ,uBAGtB1F,EAAE4L,UAAUH,KAAK,oBAAqB,WACpC3J,QAAQC,IAAI,yBACZN,EAAKO,IAAI6J,uBAGbd,WAAWhK,UAAUiC,OAAS,WAC5BnC,KAAKmK,YAAYhI,UAKnBhD,EAAEC,QAAQ6L,MAAM,WACd,IAAIC,EAAc,IAAI/G,YAClB3D,EAAW,IAAIT,SAEnBX,OAAO2F,GAAK3F,OAAO2F,SAAMqE,EAEzB,IAAI+B,EAAQ,IAAIrG,YAAY1F,OAAO2F,GAAImG,GACvCC,EAAMlG,OAEN7F,OAAOjB,EAAI,IAAIoH,UAAUnG,OAAOd,OAAQkC,GACxC4K,GAAK,IAAIlB,WACTvJ,SAAW,IAAI0K,SAASH,GAExB,IAAII,EAAM,IAAIjL,mBAAmBjB,OAAOjB,EAAG+M,EAAa1K,EAAUpB,OAAOd,OAAQ8M,GAAIzK,UAErFyK,GAAGjK,IAAMmK,EAAInK,IAEb/B,OAAO8L,YAAcA,EAErBA,EAAYnK,GAAG,WAAY,SAASwF,GAClC4E,EAAMhG,SAASmG,EAAInK,KACnBiK,GAAG9E,SACH3F,SAAS2F,SACTnI,EAAEmI,OAAOC,GACT+E,EAAInK,IAAIiE,cAGV8F,EAAYnK,GAAG,iBAAkB,WAC/B3B,OAAOmM,SAASC,QAAO,OAK3B,IAAIH,SAAW,SAAS9K,GACtBP,KAAKO,OAASA,GAEhB8K,SAASnL,UAAUoG,OAAS,WAC1BtG,KAAKW,SAAWoK,SAASU,eAAe,aAE1CJ,SAASnL,UAAUwL,QAAU,WAC3B1L,KAAKO,OAAOgB,KAAK,SACjBvB,KAAK6D,UAEPwH,SAASnL,UAAU6D,OAAS,WACO,WAA7BnD,KAAKD,SAASgL,aAChB3L,KAAKW,SAASiL,UAAY,WAG9BP,SAASnL,UAAU2D,OAAS,WAC1B,IAAIjD,EAAOZ,KACqB,WAA5BY,EAAKD,SAASiL,YAChBhL,EAAKD,SAASiL,UAAY,SAC1BvK,WAAW,WACTT,EAAKD,SAASiL,UAAY,IACzB,QAIP,IAAIC,kBAAoB,SAASpL,GAC/BT,KAAK8L,YAAc,EACnB9L,KAAK8I,cAAgB,EACrB9I,KAAK4G,eAAiB,EAAE,GAG1BiF,kBAAkB3L,UAAUoG,OAAS,SAASc,GAC5C,IAAIjB,EAAeiB,EAAMjB,aACrBP,EAAQwB,EAAMxB,MACdQ,EAAkBgB,EAAMhB,gBACxBN,EAASsB,EAAMtB,OACfE,EAASoB,EAAMpB,OACfC,EAAMmB,EAAMnB,IAGhBjG,KAAK8L,YAAc3F,EAAaxH,EAAI,GAGpC,IAAIoN,EAAU3F,EAAgBS,EAAI7G,KAAK8L,YACnCE,EAAU5F,EAAgBU,EAAI9G,KAAK8L,YAEnCG,EAAY9F,EAAaxH,EAAK,EAAEqB,KAAK8L,YAEzC9L,KAAKqH,UACH1I,EAAIwH,EAAaxH,EAAK,EAAEqB,KAAK8L,YAC7BlN,EAAc,EAAXqN,EAAa,GAElB,IAAI1D,EAAQ3C,EAAMoB,KAAK+E,EAASC,EAAShM,KAAKqH,SAAS1I,EAAGqB,KAAKqH,SAASzI,GACxE2J,EAAMtB,MAAMC,KAAQ,UACpB,IAAIgF,EAAMtG,EAAMqE,MAAM,KAAM8B,EAASC,EAAShM,KAAKqH,SAAS1I,EAAGqB,KAAKqH,SAASzI,GAE7EoH,EAAOmB,KAAK+E,GACZpG,EAAOqB,KAAKoB,GACZtC,EAAIkB,KAAK+E,GACTjG,EAAIkB,KAAKoB,GAET,IAAK,IAAI4D,EAAI,EAAGA,EAAI,EAAGA,IACrB5D,EAAQA,EAAM6D,QACdF,EAAMA,EAAIE,QACV7D,EAAMhB,UAAU,EAAGvH,KAAKqH,SAASzI,EAAIoB,KAAK8L,aAC1CI,EAAI3E,UAAU,EAAGvH,KAAKqH,SAASzI,EAAIoB,KAAK8L,aACxChG,EAAOqB,KAAKoB,GACZvC,EAAOmB,KAAK+E,GACZjG,EAAIkB,KAAKoB,GACTtC,EAAIkB,KAAK+E,GAGX,OAAOlM,KAAKqH,UAGd,IAAIgF,kBAAoB,SAAS5L,GAC7BT,KAAK8L,YAAc,EACnB9L,KAAK8I,cAAgB,EACrB9I,KAAK4G,eAAiB,KAG1ByF,kBAAkBnM,UAAUoG,OAAS,SAASc,GAC5C,IAAIjB,EAAeiB,EAAMjB,aACrBP,EAAQwB,EAAMxB,MACdQ,EAAkBgB,EAAMhB,gBACxBN,EAASsB,EAAMtB,OACfE,EAASoB,EAAMpB,OACfC,EAAMmB,EAAMnB,IAGhBjG,KAAK8L,YAAc3F,EAAaxH,EAAI,GAGpC,IAAIoN,EAAU3F,EAAgBS,EAAI7G,KAAK8L,YACnCE,EAAU5F,EAAgBU,EAAI9G,KAAK8L,YACvC9L,KAAKqH,UACD1I,GAAIwH,EAAaxH,EAAK,EAAEqB,KAAK8L,aAAc,EAC3ClN,GAAIuH,EAAavH,EAAK,EAAEoB,KAAK8L,aAAc,GAE/C,IAAIvD,EAAQ3C,EAAMoB,KAAK+E,EAASC,EAAShM,KAAKqH,SAAS1I,EAAGqB,KAAKqH,SAASzI,GACxE2J,EAAMtB,MAAMC,KAAQ,UACpB,IAAIgF,EAAMtG,EAAMqE,MAAM,KAAM8B,EAASC,EAAShM,KAAKqH,SAAS1I,EAAGqB,KAAKqH,SAASzI,GAkC7E,OAhCAoH,EAAOmB,KAAK+E,GACZpG,EAAOqB,KAAKoB,GACZtC,EAAIkB,KAAK+E,GACTjG,EAAIkB,KAAKoB,GAETA,EAAQA,EAAM6D,QACdF,EAAMA,EAAIE,QACV7D,EAAMhB,UAAUvH,KAAKqH,SAAS1I,EAAIqB,KAAK8L,YAAa,GACpDI,EAAI3E,UAAUvH,KAAKqH,SAAS1I,EAAIqB,KAAK8L,YAAa,GAClDhG,EAAOqB,KAAKoB,GACZvC,EAAOmB,KAAK+E,GACZjG,EAAIkB,KAAKoB,GACTtC,EAAIkB,KAAK+E,GAET3D,EAAQA,EAAM6D,QACdF,EAAMA,EAAIE,QACV7D,EAAMhB,YAAYvH,KAAKqH,SAAS1I,EAAIqB,KAAK8L,aAAc9L,KAAKqH,SAASzI,EAAIoB,KAAK8L,aAC9EI,EAAI3E,YAAYvH,KAAKqH,SAAS1I,EAAIqB,KAAK8L,aAAc9L,KAAKqH,SAASzI,EAAIoB,KAAK8L,aAC5EhG,EAAOqB,KAAKoB,GACZvC,EAAOmB,KAAK+E,GACZjG,EAAIkB,KAAKoB,GACTtC,EAAIkB,KAAK+E,GAET3D,EAAQA,EAAM6D,QACdF,EAAMA,EAAIE,QACV7D,EAAMhB,UAAUvH,KAAKqH,SAAS1I,EAAIqB,KAAK8L,YAAa,GACpDI,EAAI3E,UAAUvH,KAAKqH,SAAS1I,EAAIqB,KAAK8L,YAAa,GAClDhG,EAAOqB,KAAKoB,GACZvC,EAAOmB,KAAK+E,GACZjG,EAAIkB,KAAKoB,GACTtC,EAAIkB,KAAK+E,GAEFlM,KAAKqH,UAId,IAAIiF,oBAAsB,SAAS7L,GACjCT,KAAK8I,cAAgB,EACrB9I,KAAKuM,MAAS5N,EAAG,IAAMC,EAAG,KAC1BoB,KAAKwM,WAAa7N,EAAG,OAAQC,EAAE,QAC/BoB,KAAKyM,aAAe,GACpBzM,KAAK4G,eAAiB,EAAE,GAG1B0F,oBAAoBpM,UAAUoG,OAAS,SAASc,GAC9C,IAAIjB,EAAeiB,EAAMjB,aACrBP,EAAQwB,EAAMxB,MACdQ,EAAkBgB,EAAMhB,gBACxBN,EAASsB,EAAMtB,OACfE,EAASoB,EAAMpB,OACfC,EAAMmB,EAAMnB,IAEZ8C,EAAc5C,EAAavH,EAAIoB,KAAKuM,KAAK3N,EAEzCyI,GACF1I,EAAGoK,EAAc/I,KAAKwM,UAAU7N,EAChCC,EAAGmK,EAAc/I,KAAKwM,UAAU5N,GAE9B8N,EAAU1M,KAAKyM,aAAe1D,EAC9BR,EAAQ3C,EAAMoB,KAAKZ,EAAgBS,EAAGT,EAAgBU,EAAI4F,EAASrF,EAAS1I,EAAG0I,EAASzI,GAC5F2J,EAAMtB,MAAMC,KAAQ,QAASzB,GAAM,WACnC,IAAIyG,EAAMtG,EAAMqE,MAAM,KAAM7D,EAAgBS,EAAGT,EAAgBU,EAAI4F,EAASrF,EAAS1I,EAAG0I,EAASzI,GAEjGoH,EAAOmB,KAAK+E,GACZpG,EAAOqB,KAAKoB,GACZtC,EAAIkB,KAAK+E,GACTjG,EAAIkB,KAAKoB,GAET,IAAK,IAAI4D,EAAI,EAAGA,EAAI,EAAGA,IACrB5D,EAAQA,EAAM6D,QACdF,EAAMA,EAAIE,QACV7D,EAAMhB,UAAUmF,EAAUrF,EAAS1I,EAAG,GACtC4J,EAAMtB,MAAMxB,GAAM,QAAU0G,IAC5BD,EAAI3E,UAAUmF,EAAUrF,EAAS1I,EAAG,GACpCmH,EAAOqB,KAAKoB,GACZvC,EAAOmB,KAAK+E,GACZjG,EAAIkB,KAAKoB,GACTtC,EAAIkB,KAAK+E,GAGX,OAAO7E,GAGT,IAAIsF,cAAgB,SAASlM,GACzBT,KAAKS,OAASA,EAEdT,KAAK4F,MAAQgH,OACb5M,KAAK4F,MAAMqB,MACT4F,SAAU,EAAG,EAAG,IAAM,OAExBD,KAAKE,OAAO,aAAaC,OAAO/M,KAAK4F,OAWrC5F,KAAK8I,cAAgB,EAYrBkE,WAAW9M,UAAU+M,sBAAwBD,WAAW9M,UAAU+M,uBAAyB,SAASC,GAClG,OAAOA,EAAKC,eAAeC,UAAUC,SAASrN,KAAKmN,iBAGrDP,KAAKU,OAAQ,SAAUV,EAAMW,EAASC,EAAOC,GA2L3C,SAASC,EAAaC,EAAMC,EAAMC,EAAIC,GACpC,IACIC,EAAc/N,KAAKgO,eAAgBH,EAAIC,GACvCG,EAAKjO,KAAK4F,MAAMsI,KAAKC,iBAEzBF,EAAGpH,EAAIkH,EAAYlH,EAAI7G,KAAK6C,KAAK,MAAMgE,EACvCoH,EAAGnH,EAAIiH,EAAYjH,EAAI9G,KAAK6C,KAAK,MAAMiE,EAEvC,IAAIsH,EAAUpO,KAAKqO,cAAeJ,GAElCjO,KAAKsO,UAAWtO,KAAK6C,KAAK,MAAM0L,oBAAsB,KAASH,EAAQvH,EAAGuH,EAAQtH,IAIpF,SAAS0H,EAAc3H,EAAGC,EAAG2H,GAC3BzO,KAAK6C,KAAK,MAAO7C,KAAK0O,WACtB1O,KAAK6C,KAAK,KAAM7C,KAAKgO,eAAgBnH,EAAGC,IACxC9G,KAAK6C,KAAK,KAAM7C,KAAKsO,YAAYK,aA3MnCpB,EAAQrN,UAAUiI,KAAO,WACvBnI,KAAKiH,MAAOgB,QAAW,KAIzBsF,EAAQrN,UAAUgI,KAAO,WACvBlI,KAAKiH,MAAOgB,QAAW,KAIzBsF,EAAQrN,UAAU0O,UAAY,WAC5B,IAAIC,EAAO7O,KAAK0O,UAChB,OAAQ7H,EAAGgI,EAAKC,GAAIhI,EAAE+H,EAAKE,KAE7BxB,EAAQrN,UAAU8O,QAAU,WAC1B,IAAIH,EAAO7O,KAAK0O,UAChB,OAAQ/P,EAAGkQ,EAAKxP,MAAOT,EAAEiQ,EAAKtP,SAEhCgO,EAAQrN,UAAU+O,OAAS,WACzB,IAAIJ,EAAO7O,KAAK0O,UAChB,OAAQ7H,EAAGgI,EAAKhI,EAAGC,EAAE+H,EAAK/H,IAE5ByG,EAAQrN,UAAUgP,qBAAuB,SAASC,EAAaC,EAAMC,EAAUC,EAASC,GACtF,IAAIC,EAAQ,EACRC,EAAQ,EACZ,OAAQL,GACN,IAAK,SACL,IAAIM,EAAIP,EAAYP,YAChBe,EAAQ3P,KAAKiP,SACbW,EAAS5P,KAAKgP,UACdQ,EAAQE,EAAE7I,EAAK+I,EAAOjR,EAAI,EAC1B8Q,EAAQC,EAAE5I,EAAK8I,EAAOhR,EAAI,EAE9B4Q,EAASG,EAAM9I,EAAI2I,EAAQ,GAAKG,EAAM9I,EAAI2I,GAASA,EAAQG,EAAM9I,EACjE4I,EAASE,EAAM7I,EAAI2I,EAAQ,GAAKE,EAAM7I,EAAI2I,GAASA,EAAQE,EAAM7I,EACjE,MACA,IAAK,UACD+I,EAAUV,EAAYF,SAG1BO,GAFIG,EAAQ3P,KAAKiP,UAEFpI,EAAIgJ,EAAQhJ,EAAI,GAAK8I,EAAM9I,EAAIgJ,EAAQhJ,GAAKgJ,EAAQhJ,EAAI8I,EAAM9I,EAC7E4I,EAASE,EAAM7I,EAAI+I,EAAQ/I,EAAI,GAAK6I,EAAM7I,EAAI+I,EAAQ/I,GAAK+I,EAAQ/I,EAAI6I,EAAM7I,EAC7E,MACA,IAAK,aACD+I,EAAUV,EAAYT,UAG1Bc,GAFIG,EAAQ3P,KAAKiP,UAEFpI,EAAIgJ,EAAQhJ,EAAI,GAAK8I,EAAM9I,EAAIgJ,EAAQhJ,GAAKgJ,EAAQhJ,EAAI8I,EAAM9I,EAC7E4I,EAASE,EAAM7I,EAAI+I,EAAQC,GAAK,GAAKH,EAAM7I,EAAI+I,EAAQC,IAAMD,EAAQC,GAAKH,EAAM7I,EAChF,MACA,IAAK,WACL,IAAI+I,EAAUV,EAAYF,SACtBc,EAAQZ,EAAYH,UACpBY,EAAS5P,KAAKgP,UAGlBQ,GAFIG,EAAQ3P,KAAKiP,UAEFpI,EAAIgJ,EAAQhJ,EAAI,GAAK8I,EAAM9I,EAAIgJ,EAAQhJ,GAAKgJ,EAAQhJ,EAAI8I,EAAM9I,EAC7E4I,EAASE,EAAM7I,EAAI+I,EAAQ/I,EAAI,GAAK6I,EAAM7I,EAAI+I,EAAQ/I,GAAK+I,EAAQ/I,EAAI6I,EAAM7I,EAC7E0I,GAASO,EAAMpR,EAAIiR,EAAOjR,EAC1B,MACA,IAAK,cACL,IAAIkR,EAAUV,EAAYT,UACtBqB,EAAQZ,EAAYH,UACpBY,EAAS5P,KAAKgP,UAGlBQ,GAFIG,EAAQ3P,KAAKiP,UAEFpI,EAAIgJ,EAAQG,GAAK,GAAKL,EAAM9I,EAAIgJ,EAAQG,IAAMH,EAAQG,GAAKL,EAAM9I,EAChF4I,EAASE,EAAM7I,EAAI+I,EAAQC,GAAK,GAAKH,EAAM7I,EAAI+I,EAAQC,IAAMD,EAAQC,GAAKH,EAAM7I,EAChF,MACA,IAAK,YACL,IAAI4I,EAAIP,EAAYP,YAChBqB,EAAOd,EAAYF,SACnBU,EAAQ3P,KAAKiP,SACbW,EAAS5P,KAAKgP,UACdQ,EAAQE,EAAE7I,EAAK+I,EAAOjR,EAAI,EAE9B6Q,EAASG,EAAM9I,EAAI2I,EAAQ,GAAKG,EAAM9I,EAAI2I,GAASA,EAAQG,EAAM9I,EACjE4I,EAASE,EAAM7I,EAAImJ,EAAKnJ,EAAI,GAAK6I,EAAM7I,EAAImJ,EAAKnJ,GAAKmJ,EAAKnJ,EAAI6I,EAAM7I,EACpE,MACA,IAAK,eACL,IAAI4I,EAAIP,EAAYP,YAChBqB,EAAOd,EAAYT,UACnBiB,EAAQ3P,KAAKiP,SACbW,EAAS5P,KAAKgP,UACdQ,EAAQE,EAAE7I,EAAK+I,EAAOjR,EAAI,EAE9B6Q,EAASG,EAAM9I,EAAI2I,EAAQ,GAAKG,EAAM9I,EAAI2I,GAASA,EAAQG,EAAM9I,EACjE4I,EAASE,EAAM7I,EAAImJ,EAAKH,GAAK,GAAKH,EAAM7I,EAAImJ,EAAKH,IAAMG,EAAKH,GAAKH,EAAM7I,EACvE,MACA,IAAK,aACL,IAAI4I,EAAIP,EAAYP,YAChBqB,EAAOd,EAAYF,SACnBU,EAAQ3P,KAAKiP,SACbW,EAAS5P,KAAKgP,UACdS,EAAQC,EAAE5I,EAAK8I,EAAOhR,EAAI,EAE9B4Q,EAASG,EAAM9I,EAAIoJ,EAAKpJ,EAAI,GAAK8I,EAAM9I,EAAIoJ,EAAKpJ,GAAKoJ,EAAKpJ,EAAI8I,EAAM9I,EACpE4I,EAASE,EAAM7I,EAAI2I,EAAQ,GAAKE,EAAM7I,EAAI2I,GAASA,EAAQE,EAAM7I,EACjE,MACA,IAAK,cACL,IAAI4I,EAAIP,EAAYP,YAChBsB,EAAOf,EAAYT,UACnBiB,EAAQ3P,KAAKiP,SACbW,EAAS5P,KAAKgP,UACdS,EAAQC,EAAE5I,EAAK8I,EAAOhR,EAAI,EAE9B4Q,EAASG,EAAM9I,EAAIqJ,EAAKF,GAAK,GAAKL,EAAM9I,EAAIqJ,EAAKF,IAAME,EAAKF,GAAKL,EAAM9I,EACvE4I,EAASE,EAAM7I,EAAI2I,EAAQ,GAAKE,EAAM7I,EAAI2I,GAASA,EAAQE,EAAM7I,EACjE,MACA,QACA7F,QAAQC,IAAI,0DASd,YALwB,IAAd,IAA2BoO,EAAU,QACvB,IAAd,IAA2BC,EAAU,GAC/CC,GAAgBF,EAChBG,GAAgBF,EAERF,EAAW,IAAIG,EAAM,IAAIC,EAAQ,IAAID,EAAM,IAAIC,GAGzDlC,EAAQrN,UAAUiQ,eAAiB,SAAUtJ,EAAGC,GAC9C,IAAImH,EAAKjO,KAAK4F,MAAMsI,KAAKC,iBACrBiC,EAASpQ,KAAK4O,YAElB,OADAX,EAAGpH,EAAIuJ,EAAOvJ,EAAGoH,EAAGnH,EAAIsJ,EAAOtJ,EACxBmH,EAAGoC,gBAAiBrQ,KAAK4F,MAAMsI,KAAKf,eAAeC,YAG5DG,EAAQrN,UAAUmO,cAAgB,SAAUiC,GAC1C,IAAIjC,EAAgBrO,KAAKkO,KAAKjB,sBAAuBjN,KAAK4F,MAAMsI,MAAOd,UAEvE,OADAiB,EAAc7L,EAAI6L,EAAc1L,EAAI,EAC7B2N,EAAYD,gBAAiBhC,IAGtCd,EAAQrN,UAAUqQ,UAAY,WAY5B,IAAIC,EAAcxQ,KAAKmQ,iBAEnBM,EAAazQ,KAAK4F,MAAMuK,iBACxBlC,EAAKjO,KAAK4F,MAAMsI,KAAKC,iBAEzBF,EAAGpH,EAAI4J,EAAW5J,EAAI2J,EAAY3J,EAClCoH,EAAGnH,EAAI2J,EAAW3J,EAAI0J,EAAY1J,EAElC,IAAIsH,EAAUpO,KAAKqO,cAAeJ,GAIlC,OAHkBjO,KAAKsO,YAAYK,YAGfJ,oBAAsB,KAASH,EAAQvH,EAAGuH,EAAQtH,IAIxEyG,EAAQrN,UAAUwQ,IAAM,SAAUtJ,GAEhC,IAAIoJ,EAAcpJ,EAAM+I,iBACpBQ,EAAM3Q,KAAKgO,eAAewC,EAAY3J,EAAG2J,EAAY1J,GACrDmH,EAAKjO,KAAKqO,cAAcsC,GAG5B,MADQ,KAAO1C,EAAGpH,EAAGoH,EAAGnH,IAO1ByG,EAAQrN,UAAU8N,eAAiB,SAAUnH,EAAGC,GAC9C,IAAImH,EAAKjO,KAAK4F,MAAMsI,KAAKC,iBAEzB,OADAF,EAAGpH,EAAIA,EAAGoH,EAAGnH,EAAIA,EACVmH,EAAGoC,gBAAiBrQ,KAAK4F,MAAMsI,KAAKf,eAAeC,YAG5DG,EAAQrN,UAAU0Q,QAAU,WAC1B,OAAO5Q,KAAK6Q,KAAMnD,EAAac,OA0BvC7B,cAAczM,UAAUoG,OAAS,SAAS3B,GACxC,IAAI3G,EAAOgC,KAAK4F,MAiBhB,OAhBAgH,KAAKkE,KAAK,sBAAuB,SAASjO,GACxC,IAAIkO,EAAKlO,EAAKiK,OAAO,OAUrB,GADA9O,EAAK+O,OAAOgE,GACRpM,EAAI,CACN,IAAIqM,EAAUD,EAAGjE,OAAO,WACxBnI,EAAGqM,MAGAhR,KAAK4F,OAuEd+G,cAAczM,UAAUsH,SAAW,WAM/B,OALAC,OACAA,IAAIN,KAAK,sBAAwBnH,KAAKiG,IAAIyB,QAC1CD,IAAIN,KAAK,yBAA2BnH,KAAK8F,OAAO4B,QAChDD,IAAIN,KAAK,uBAAyBnH,KAAKiG,IAAI,GAAGgB,KAAK,SAAW,IAAMjH,KAAKiG,IAAI,GAAGgB,KAAK,WACrFQ,IAAIN,KAAK,mBAAqBnH,KAAKqH,SAAS1I,EAAI,IAAMqB,KAAKqH,SAASzI,GAC7D6I,IAAIE,KAAK,OAYlBgF,cAAczM,UAAU6C,eAAiB,SAAS6E,EAAS3J,EAAK0G,GAC9D,IACIoD,EADO/H,KACQ8M,OAAO,UAAU7O,EAAM,IAG1C,OAFY8J,EAAQqE,QAELrE,IA4BjB4E,cAAczM,UAAU9B,UAAY,SAASH,EAAKmK,EAAKzC,EAAO2C,GAC1D,IAAIT,EAAO7H,KAAK4F,MAGZiJ,EAAOhH,EAAKiF,OAAO,UAAY7O,EAAM,IAAIyQ,UAEzCjG,GADSoG,EAAKhI,EACLgI,EAAKxP,OAGduJ,GAFSiG,EAAK/H,EACL+H,EAAKtP,OACJsP,EAAKC,IACfjG,EAAUgG,EAAKE,GASfkC,EADMrE,KAAKE,OAAO,OACV4B,UAERrI,GAAoBQ,EAAGoK,EAAEnC,GACLhI,EAAGmK,EAAElC,IAIzBtI,EAAKJ,EAAgBQ,EAAI+B,EACzBlC,EAAML,EAAgBS,EAAI+B,EAC1BE,EAAckI,EAAE5R,MAAQoJ,EAC5B,MAAY,QAARL,GAAiBzC,EAAMvF,QACvB2I,EAAc,EACdtC,GAAMd,EAAMvF,OAAOqG,GACnBC,GAAMf,EAAMvF,OAAOsG,GACnBmB,EAAK3F,SACDoM,UAAW,KAAO,EAAG,EAAGjI,EAAgBQ,EAAGR,EAAgBS,GAAGa,KAAK,MAtB3D,IAuBEuJ,KAAKC,OACnB,WACItJ,EAAK3F,SACDmG,YAAe5B,EAAG,IAAIC,GA1BlB,IA2BMwK,KAAKE,UAAW9I,KAE3B,MACQ,QAARF,GACPP,EAAK3F,SACDoM,UAAW,IAAK7H,EAAG,IAAKC,GAhChB,IAkCEwK,KAAKE,YAOf3K,GAAIA,EACJC,GAAIA,EACJqC,YAAaA,SAbd,GAkBb4D,cAAczM,UAAUmR,aAAe,aASvC1E,cAAczM,UAAUoR,mBAAqB,WAC3C,OAAOtR,KAAK4F,MAAMkH,OAAO,YAc3B,IAAIyE,gBAAkB,SAAS9Q,GAC3BT,KAAK8L,YAAc,EACnB9L,KAAK8I,cAAgB,EACrB9I,KAAKwR,UAAY,EACjBxR,KAAK4G,eAAiB,EAAE,GAG5B2K,gBAAgBrR,UAAUoG,OAAS,SAASc,GACxC,IAAIjB,EAAeiB,EAAMjB,aACrBP,EAAQwB,EAAMxB,MACdQ,EAAkBgB,EAAMhB,gBACxBN,EAASsB,EAAMtB,OACfE,EAASoB,EAAMpB,OACfC,EAAMmB,EAAMnB,IAGhBjG,KAAK8L,YAAc3F,EAAaxH,EAAI,GAGpC,IAAIoN,EAAU3F,EAAgBS,EAAI7G,KAAK8L,YACnCE,EAAU5F,EAAgBU,EAAI9G,KAAK8L,YAEnCG,EAAY9F,EAAaxH,EAAK,EAAEqB,KAAK8L,YAErCzE,GACA1I,EAAGsN,EACHrN,EAAc,EAAXqN,EAAa,GAEhB1D,EAAQ3C,EAAMoB,KAAK+E,EAASC,EAAS3E,EAAS1I,EAAG0I,EAASzI,GAC9D2J,EAAMtB,MAAMC,KAAQ,UACpB,IAAIgF,EAAMtG,EAAMqE,MAAM,KAAM8B,EAASC,EAAS3E,EAAS1I,EAAG0I,EAASzI,GAEnEoH,EAAOmB,KAAK+E,GACZpG,EAAOqB,KAAKoB,GACZtC,EAAIkB,KAAK+E,GACTjG,EAAIkB,KAAKoB,GAET,IAAK,IAAI4D,EAAI,EAAGA,EAAI,EAAGA,IACjBA,GAAKnM,KAAKwR,YACZjJ,EAAMhB,UAAU,EAAGF,EAASzI,EAAIoB,KAAK8L,aACrCI,EAAI3E,UAAU,EAAGF,EAASzI,EAAIoB,KAAK8L,cAErCvD,EAAQA,EAAM6D,QACdF,EAAMA,EAAIE,QACV7D,EAAMhB,UAAU,EAAGF,EAASzI,EAAIoB,KAAK8L,aACrCI,EAAI3E,UAAU,EAAGF,EAASzI,EAAIoB,KAAK8L,aACnChG,EAAOqB,KAAKoB,GACZvC,EAAOmB,KAAK+E,GACZjG,EAAIkB,KAAKoB,GACTtC,EAAIkB,KAAK+E,GAGX,OAAO7E","file":"../js/shmile-ui.js","sourcesContent":["/**\n * A class of utility methods.\n */\n var CameraUtils = function() {};\n\n/**\n * Play the snap effect.\n * @param {Integer} idx\n *   The frame index to place the updated image.\n * @param {Function} cheeseCB\n *   Code to execute after \"Cheese\" is displayed.\n *   Typically, this wraps the command to fire the shutter.\n */\nCameraUtils.snap = function(idx, cheeseCb) {\n  p.zoomFrame(idx, 'in');\n  // These guys need to be promises.\n  p.modalMessage('Ready?', Config.ready_delay, 200, function() {\n    p.modalMessage(\"3\", 1000, 200, function() {\n      p.modalMessage(\"2\", 1000, 200,  function() {\n        p.modalMessage(\"1\", 1000, 200, function() {\n          cheeseCb();\n        });\n      });\n    });\n  });\n}\n\n/**\n * Given a max w and h bounds, return the dimensions\n * of the largest 4x6 rect that will fit within.\n */\nCameraUtils.scale4x6 = function(maxw, maxh) {\n    var s0 = 6/4; // width / height\n    var s1 = maxw/maxh;\n\n    // Then the width is longer. Use the shorter side (height)\n    if (s0 <= s1) {\n        return {w: maxh * 6/4, h: maxh};\n    } else {\n        return {w: maxw, h: maxw * 4/6}\n    }\n}\n\nCameraUtils.scale4x1 = function(maxw, maxh) {\n    var s0 = 6/4; // width / height\n    var s1 = maxw/maxh;\n\n    // Then the width is longer. Use the shorter side (height)\n    if (s0 <= s1) {\n        return {w: maxh * 4/6 * 0.5, h: maxh};\n    } else {\n        return {w: maxw, h: maxw * 6/4 * 0.5}\n    }\n}\n\n/**\n * Given a max w and h bounds, return the dimensions\n * of the largest 3x8 rect that will fit within.\n */\nCameraUtils.scale3x8 = function(maxw, maxh) {\n    var s0 = 8/3; // width / height\n    var s1 = maxw/maxh;\n\n    // Then the width is longer. Use the shorter side (height)\n    if (s0 <= s1) {\n        return {w: maxh * s0, h: maxh};\n    } else {\n        return {w: maxw, h: maxw * (1/s0)}\n    }\n}\n\nCameraUtils.scale = function(maxw, maxh, s0) {\n    // var s0 = 8/3; // width / height\n    var s1 = maxw/maxh;\n\n    // Then the width is longer. Use the shorter side (height)\n    if (s0 <= s1) {\n        return {w: maxh * s0, h: maxh};\n    } else {\n        return {w: maxw, h: maxw * (1/s0)}\n    }\n}\n\nvar Config = {\n  photo_margin: 50, // Margin for the composite photo per side\n  window_width: $(window).width(),\n  window_height: $(window).height() - 10,\n  overlay_delay: 2000,\n  next_delay: 10000,\n  cheese_delay: 400,\n  flash_duration: 1000,\n  ready_delay: 2000,\n  nice_delay: 5000,\n\n  // The amount of time we should pause between each frame shutter\n  // I tend to bump this up when 1) photobooth participants want more\n  // time to review their photos between shots, and 2) when I'm shooting\n  // with external flash and the flash needs more time to recharge.\n  between_snap_delay: 1000,\n\n  // For usability enhancements on iPad, set this to \"true\"\n  is_mobile: false\n}\n\n/**\n * Describes the current state of the UI.\n */\nvar AppState = function() {\n  this.reset();\n};\n\nAppState.prototype.reset = function() {\n  this.current_frame_idx = 0;\n  this.zoomed = null;\n}\n\n\n/*\n * STATE MACHINE DEFINITION\n * Keep track of app state and logic.\n *\n * + loading\n *   - connected() -> ready\n * + ready\n *   - ui_button_pressed() (DOM button click) -> waiting_for_photo\n * + waiting_for_photo\n *   - photo_saved() -> review_photo\n * + review_photo\n *   - photo_updated() -> next_photo\n * + next_photo\n *   - continue_partial_set() -> waiting_for_photo\n *   - finish_set() -> ready\n *\n * @param [PhotoView]\n * @param [Socket]            The initialized Socket\n * @param [AppState] appState Global initialized state\n * @param [Config] config     The configuration options passed to the app\n */\nvar ShmileStateMachine = function(photoView, socket, appState, config, buttonView, snackbar) {\n  this.photoView = photoView;\n  this.socket = socket;\n  this.appState = appState;\n  this.config = config;\n  this.buttonView = buttonView;\n  this.snackbar = snackbar;\n\n  var self = this;\n\n  this.buttonPrint = null;\n  this.shouldSendNotPrinting = false;\n\n  self.socket.on(\"printer_enabled\", function(optionalPrinting){\n    console.log(\"socket printer_enabled received, optionalPrinting is\" + optionalPrinting);\n      if (optionalPrinting) {\n        self.shouldSendNotPrinting = true;\n        self.fsm.show_print_message();\n        // FIXME: consider a bigger timeout here?\n        self.buttonPrint = setTimeout(function(){\n          // alert(\"Hello\");\n          self.fsm.show_message();\n        }, self.config.next_delay);\n      } else {\n        self.socket.emit('print');\n        setTimeout(function(){\n          self.fsm.print_set();\n        }, self.config.next_delay);\n      }\n  });\n  self.socket.on(\"review_composited\", function() {\n    setTimeout(function() {\n      self.fsm.show_message()\n    }, self.config.next_delay);\n  });\n  self.socket.on(\"print\", function() {\n    self.fsm.print_set();\n  });\n\n  this.fsm = StateMachine.create({\n    initial: 'loading',\n    events: [\n      { name: 'connected', from: 'loading', to: 'ready' },\n      { name: 'ui_button_pressed', from: 'ready', to: 'waiting_for_photo' },\n      { name: 'photo_saved', from: 'waiting_for_photo', to: 'review_photo' },\n      { name: 'photo_updated', from: 'review_photo', to: 'next_photo' },\n      { name: 'continue_partial_set', from: 'next_photo', to: 'waiting_for_photo' },\n      { name: 'finish_set', from: 'next_photo', to: 'review_composited' },\n      { name: 'show_print_message', from: 'review_composited', to: 'print_message' },\n      { name: 'print_set', from: ['print_message', 'review_composited'], to: 'printing'},\n      // { name: 'print_ok', from: 'printing', to: 'ready'},\n      { name: 'print_not_ok', from: 'printing', to: 'show_error_message'},\n      { name: 'show_message', from: ['review_composited', 'print_message', 'printing', 'show_error_message'], to: 'show_goodbye_message'},\n      { name: 'next_set', from: 'show_goodbye_message', to: 'ready'}\n    ],\n    callbacks: {\n      onconnected: function() {\n        console.log(\"onconnected\");\n        self.photoView.animate('in', function() {\n          self.buttonView.fadeIn();\n        });\n      },\n      onenterready: function() {\n        self.shouldSendNotPrinting = false;\n        self.photoView.resetState();\n      },\n      onleaveready: function() {\n      },\n      onenterwaiting_for_photo: function(e) {\n        cheeseCb = function() {\n          self.photoView.modalMessage('Cheese!', self.config.cheese_delay);\n          self.photoView.flashStart();\n          self.socket.emit('snap', true);\n        }\n        CameraUtils.snap(self.appState.current_frame_idx, cheeseCb);\n      },\n      onphoto_saved: function(e, f, t, data) {\n        // update UI\n        // By the time we get here, the idx has already been updated!!\n        self.photoView.flashEnd();\n        self.photoView.updatePhotoSet(data.web_url, self.appState.current_frame_idx, function() {\n          setTimeout(function() {\n            self.fsm.photo_updated();\n          }, self.config.between_snap_delay)\n        });\n      },\n      onphoto_updated: function(e, f, t) {\n        self.photoView.flashEnd();\n        // We're done with the full set.\n        var pictures = self.photoView.getPicturesTotal()\n        if (self.appState.current_frame_idx == pictures - 1) {\n          self.fsm.finish_set();\n        }\n        // Move the frame index up to the next frame to update.\n        else {\n          self.appState.current_frame_idx = (self.appState.current_frame_idx + 1) % pictures\n          self.fsm.continue_partial_set();\n        }\n      },\n      onenterreview_composited: function(e, f, t) {\n        self.socket.emit('composite');\n        self.photoView.showOverlay(true);\n      },\n      onenterprinting: function(e, f, t) {\n        clearTimeout(self.buttonPrint);\n        self.shouldSendNotPrinting = false;\n        setTimeout(function() {\n          self.fsm.show_message();\n        }, self.config.between_snap_delay);\n      },\n      onentershow_goodbye_message: function(e, f, t) {\n        // Clean up\n        self.fsm.next_set();\n        self.snackbar.hideMe();\n        if (self.shouldSendNotPrinting) {\n          self.socket.emit('do_not_print')\n        }\n      },\n      onenterprint_message: function(e, f, t) {\n        self.snackbar.showMe();\n      },\n      onleaveshow_goodbye_message: function(e, f, t) {\n        // Clean up\n        self.photoView.animate('out');\n        self.photoView.modalMessage('Nice!', self.config.nice_delay, 200, function() {\n          self.photoView.slideInNext();\n        });\n      },\n      onchangestate: function(e, f, t) {\n        console.log('fsm received event '+ e +', changing state from ' + f + ' to ' + t)\n      }\n    }\n  });\n}\n\n/**\n * Proxy object that allows the late initialization of the socket, if one\n * exists at all. In instances where we never initialize the socket, we allow\n * for a fake Socket object using a Backbone Event channel.\n */\nvar SocketProxy = function() {\n  this.socket = null;\n  this.fakeSocket = {};\n  _.extend(this.fakeSocket, Backbone.Events)\n}\n\nSocketProxy.prototype.lateInitialize = function(socket) {\n  this.socket = socket;\n}\n\nSocketProxy.prototype.on = function(evt, cb) {\n  if (this.socket === null) {\n    console.log(\"SocketProxy 'on' delegating to fakeSocket\")\n    this.fakeSocket.on(evt, cb)\n    return\n  }\n  this.socket.on(evt, cb);\n}\n\nSocketProxy.prototype.emit = function(msg, data) {\n  if (this.socket === null) {\n    console.log(\"SocketProxy 'emit' delegating to fakeSocket\")\n    this.fakeSocket.trigger(msg, function() {\n      console.log(data)\n    });\n    return\n  }\n  this.socket.emit(msg, data);\n}\n\n/**\n * Responsible for initializing the connection to socket.io.\n * @param io [Socket]\n * @param fsm [StateMachine]\n */\nvar SocketLayer = function(io, proxy) {\n  this.io = io;\n  this.proxy = proxy;\n}\n\n/**\n * Attempt a connection to socket.io server.\n * If this fails, will no-op and silently continue.\n */\nSocketLayer.prototype.init = function() {\n  try {\n    this.socket = this.io.connect(\"/\");\n    this.proxy.lateInitialize(this.socket);\n  } catch(e) {\n    console.log(\"Error initializing socket connection: \" + e);\n  }\n  return this;\n}\n\n/**\n * Register bindings and callbacks.\n */\nSocketLayer.prototype.register = function(fsm) {\n  console.log(\"register\");\n  this.fsm = fsm;\n  var self = this;\n\n  this.proxy.on('message', function(data) {\n    console.log('message evt: data is:' + data);\n  });\n\n  this.proxy.on('connect', function() {\n    console.log('connected evt');\n    self.fsm.connected();\n  });\n\n  this.proxy.on('camera_snapped', function() {\n    console.log('camera_snapped evt');\n    //fsm.camera_snapped();\n  })\n\n  this.proxy.on('photo_saved', function(data) {\n    console.log('photo_saved evt: ' + data.filename);\n    self.fsm.photo_saved(data);\n  });\n}\n\nvar PhotoView = Backbone.View.extend({\n  id: \"#viewport\",\n\n  initialize: function(config, state) {\n    this.config = config;\n    this.paper = new Raphael('viewport', this.config.window_width, this.config.window_height);\n    this.frames = this.paper.set(); // List of SVG black rects\n    this.images = this.paper.set(); // List of SVG images\n    this.all = this.paper.set();\n    this.overlayImage = null;\n    this.compositeDim = null;\n    this.compositeOrigin = null;\n    this.compositeCenter = null;\n    this.state = state;\n  },\n\n  render: function(template) {\n    this.translationTotal = {dx:0, dy:0};\n    this.photoViewLayout = new window[template.photoView](this.config);\n\n    var w = this.config.window_width - this.config.photo_margin;\n    var h = this.config.window_height - this.config.photo_margin;\n\n    this.compositeDim = CameraUtils.scale(w, h, this.photoViewLayout.finalSizeRatio);\n    this.compositeOrigin = {\n      x: (this.config.window_width - this.compositeDim.w) / 2,\n      y: (this.config.window_height - this.compositeDim.h) / 2\n    };\n    this.compositeCenter = {\n      x: this.compositeOrigin.x + (this.compositeDim.w/2),\n      y: this.compositeOrigin.y + (this.compositeDim.h/2)\n    }\n    var r = this.paper.rect(this.compositeOrigin.x, this.compositeOrigin.y, this.compositeDim.w, this.compositeDim.h);\n\n    r.attr({'fill': 'white'});\n\n    this.all.push(r);\n\n    var stuff = {\n      \"compositeDim\": this.compositeDim,\n      \"paper\": this.paper,\n      \"compositeOrigin\": this.compositeOrigin,\n      \"frames\": this.frames,\n      \"images\": this.images,\n      \"all\": this.all\n    };\n\n    this.frameDim = this.photoViewLayout.render(stuff);\n    this.setOverlay(template.overlayImage);\n    this.all.translate(-this.config.window_width, 0);\n  },\n\n  toString: function() {\n    ret = [];\n    ret.push(\"Size of 'all' set: \" + this.all.length);\n    ret.push(\"Size of 'frames' set: \" + this.frames.length);\n    ret.push(\"Composite photo is: \" + this.all[0].attr('width') + 'x' + this.all[0].attr('height'));\n    ret.push(\"Frame photo is: \" + this.frameDim.w + 'x' + this.frameDim.h);\n    return ret.join('\\n');\n  },\n\n  /**\n   * Updates the image at the set location.\n   * @param {String} img_src\n   *   The URL of the image resource the browser should fetch and display\n   * @param {Integer} idx\n   *   Index of frame to update\n   * @param cb\n   *   The callback to be executed when the UI has finished updating and zooming out.\n   */\n  updatePhotoSet: function(img_src, idx, cb) {\n    var view = this;\n    var imgEl = view.images[idx];\n    var frameEl = view.frames[idx];\n\n    console.log(\"idx = \" + idx);\n    // var [imgEl, frameEl] = this.photoViewLayout.updatePhotoSet(img_src, idx);\n\n\n    imgEl.attr({'src': img_src, 'opacity': 0});\n    imgEl.show();\n\n    var afterShowPhoto = function () {\n      // We've found and revealed the photo, now hide the old black rect and zoom out\n      frameEl.hide();\n      p.zoomFrame(idx, 'out', cb);\n    }\n    imgEl.animate({'opacity': 1}, 200, afterShowPhoto);\n  },\n\n  /**\n   * For in: assume the view has been rendered and reset to initial state and moved out of sight.\n   * Slide in the composite image.\n   * For out: assume the composite image is centered. Move out of sight and hide.\n   */\n  animate: function(dir, cb) {\n    if (dir === 'in') {\n      if (this.overlayImage) {\n        this.overlayImage.hide();\n      }\n      this.all.animate({\n        'translation': this.config.window_width+\",0\"\n      }, 1000, \"<>\", cb);\n    } else if (dir === 'out') {\n      this.all.animate({\n        'translation': this.config.window_width+\",0\"\n      }, 1000, \"<>\", cb);\n    }\n  },\n\n  /**\n   * zoomFrame zooms into the indicated frame.\n   * Call it once to zoom in, call it again to zoom out.\n   *\n   * @param idx Frame index\n   *   Expect zoomFrame(1) to be matched immediately by zoomFrame(1)\n   * frame: 0 (upper left), 1 (upper-right), 2 (lower-left), 3 (lower-right)\n   * @param dir 'in' or 'out'\n   *   Zoom in or out\n   * @param onfinish\n   *   Callback executed when the animation is finished.\n   *\n   * Depends on the presence of the .zoomed object to store zoom info.\n   */\n   // FIXME: thsi should be a general method\n  zoomFrame: function(idx, dir, onfinish) {\n    if ((dir === \"out\" && this.state.zoomed) ||\n        (dir === \"in\" && !this.state.zoomed)) {\n      var view = this;\n      var frame = view.frames[idx];\n\n      var frameX = frame.attr('x');\n      var frameW = frame.attr('width');\n      var frameY = frame.attr('y');\n      var frameH = frame.attr('height');\n      var centerX = frameX + frameW/2;\n      var centerY = frameY + frameH/2;\n\n      var animSpeed = 1000;\n\n      // delta to translate to.\n      var dx = this.compositeCenter.x - centerX;\n      var dy = this.compositeCenter.y - centerY;\n\n      if (dir === \"out\" && this.state.zoomed) {\n        // scaleFactor = 1;\n        view.translationTotal.dx -= this.state.zoomed.dx;\n        view.translationTotal.dy -= this.state.zoomed.dy;\n        view.all.animate({\n          'scale': [1, 1, view.compositeCenter.x, view.compositeCenter.y].join(','),\n        }, animSpeed, 'bounce', //onFinish);\n        function() {\n          if (idx == view.photoViewLayout.totalPictures - 1) {\n            view.all.animate({\n              'translation': view.translationTotal.dx+','+view.translationTotal.dy\n            }, animSpeed, '<>', onfinish)\n          } else {\n            onfinish();\n          }\n        });\n        this.state.zoomed = null;\n      } else if (dir !== \"out\") {\n        var scaleFactor = this.compositeDim.h / frameH;\n        view.all.animate({\n          'translation': dx+','+dy\n        }, animSpeed, '<>', function() {\n          view.all.animate({\n            'scale': [scaleFactor, scaleFactor, view.compositeCenter.x, view.compositeCenter.y].join(','),\n          }, animSpeed, 'bounce', onfinish)\n        });\n        // Store the zoom data for next zoom.\n        this.state.zoomed =  {\n          dx: dx,\n          dy: dy\n          // scaleFactor: scaleFactor\n        };\n      }\n    }\n  },\n\n  calculateOutTranslation: function(idx, state, onfinish) {\n    var view = this;\n    var animSpeed = 1000;\n\n    if (view.shouldRestoreOutState) {\n      view.all.animate({\n        'translation': [-state.dx, -state.dy].join(',')\n      }, animSpeed, '<>', onfinish);\n    } else {\n      view.translationTotal.dx -= state.zoomed.dx;\n      view.translationTotal.dy -= state.zoomed.dy;\n      if (idx == view.totalPictures - 1) {\n        view.all.animate({\n          'translation': view.translationTotal.dx+','+view.translationTotal.dy\n        }, animSpeed, '<>', onfinish);\n      } else {\n        onfinish();\n      }\n    };\n  },\n\n  /**\n   * Reset visibility, location of composite image for next round.\n   */\n  slideInNext: function() {\n      this.resetState();\n      this.modalMessage('Next!');\n\n      this.images.hide();\n      this.frames.show();\n\n      this.translationTotal.dx = 0;\n      this.translationTotal.dy = 0;\n\n      this.all.translate(-this.config.window_width * 2, 0);\n\n      this.animate('in', function() {\n        $('#start-button').fadeIn();\n      });\n  },\n\n  /**\n   * Resets the state variables.\n   */\n  resetState: function () {\n    this.state.reset();\n  },\n\n  /**\n   * Faux camera flash\n   */\n  flashEffect: function(duration) {\n    if (duration === undefined) { duration = 200; }\n    // var rect = this.canvas.rect(0, 0, this.config.window_width, this.config.window_height);\n    var rect = this.paper.rect(0, 0, this.config.window_width, this.config.window_height);\n    rect.attr({'fill': 'white', 'opacity': 0});\n    rect.animate({'opacity': 1}, duration, \">\", function() {\n      rect.animate({'opacity': 0}, duration, \"<\");\n      rect.remove();\n    })\n  },\n\n  flashStart: function(duration) {\n    if (duration === undefined) { duration = 200; }\n    // this.rect = this.canvas.rect(0, 0, this.config.window_width, this.config.window_height);\n    this.rect = this.paper.rect(0, 0, this.config.window_width, this.config.window_height);\n    this.rect.attr({'fill': 'white', 'opacity': 0});\n    this.rect.animate({'opacity': 1}, duration, \">\")\n  },\n\n  flashEnd: function(duration) {\n    if (duration === undefined) { duration = 200; }\n    var self = this;\n    this.rect.animate({'opacity': 0}, duration, \"<\", function() {\n      self.remove();\n    });\n  },\n\n  /**\n   * Draws a modal with some text.\n   */\n  modalMessage: function(text, persistTime, animateSpeed, cb) {\n      if (animateSpeed === undefined) { var animateSpeed = 200; }\n      if (persistTime === undefined) { var persistTime = 500; }\n\n      var sideLength = this.config.window_height * 0.3;\n      var x = (this.config.window_width - sideLength)/2;\n      var y = (this.config.window_height - sideLength)/2;\n      var all = this.paper.set();\n      var r = this.paper.rect(x, y,\n      // var r = this.canvas.rect(x, y,\n          sideLength,\n          sideLength,\n          15);\n      r.attr({'fill': '#222',\n              'fill-opacity': 0.7,\n              'stroke-color': 'white'});\n      all.push(r);\n      var txt = this.paper.text(x + sideLength/2, y + sideLength/2, text);\n      txt.attr({'fill': 'white',\n          'font-size': '50',\n          'font-weight': 'bold'\n      });\n      all.push(txt);\n      all.attr({'opacity': 0});\n      all.animate({\n          'opacity': 1,\n          'scale': '1.5,1.5',\n          'font-size': '70'\n      }, animateSpeed, '>');\n\n      // Timer to delete self nodes.\n      var t = setTimeout(function(all) {\n          // Delete nodes\n          txt.remove();\n          r.remove();\n          if (cb) cb();\n      }, persistTime, all);\n  },\n\n  /**\n   * Applies the final image overlay to the composite image.\n   * This will usually contain the wedding logo: 24-bit transparent PNG\n   */\n  showOverlay: function(animate) {\n      this.overlayImage.show();\n      if (animate) {\n          //this.overlayImage.attr({'opacity':0});\n        this.overlayImage.animate({'opacity':1}, this.config.overlay_delay);\n      }\n  },\n\n  /**\n   * Removes the overlay\n   */\n  hideOverlay: function(animate) {\n    var view = this;\n    if (animate) {\n      this.overlayImage.animate({'opacity':0}, this.config.overlay_delay, function() {\n        view.overlayImage.hide();\n      });\n    } else {\n      this.overlayImage.hide();\n    }\n  },\n\n  setOverlay: function(overlayImage) {\n    // Draw the PNG logo overlay.\n    var o = this.paper.image(\n      overlayImage,\n      this.compositeOrigin.x,\n      this.compositeOrigin.y,\n      this.compositeDim.w,\n      this.compositeDim.h)\n    // var o = this.photoViewLayout.createOverlayImage(overlayImage);\n    if (!this.overlayImage) {\n      this.all.push(o);\n      // this.all.remove(this.overlayImage);\n    }\n    o.hide();\n    this.overlayImage = o;\n  },\n\n  getPicturesTotal: function() {\n    return this.photoViewLayout.totalPictures;\n  },\n\n\n});\n\nvar ButtonView = function(fsm) {\n  this.fsm = fsm;\n}\n\nButtonView.prototype.render = function() {\n  var self = this;\n  // init code\n  this.startButton = $('button#start-button');\n  var buttonX = (Config.window_width - this.startButton.outerWidth())/2;\n  var buttonY = (Config.window_height - this.startButton.outerHeight())/2;\n\n  this.startButton.hide();\n\n  // Position the start button in the center\n  this.startButton.css({'top': buttonY, 'left': buttonX});\n\n  var buttonTriggerEvt = Config.is_mobile ? \"touchend\" : \"click\";\n\n  this.startButton.bind(buttonTriggerEvt, function(e) {\n    var button = $(e.currentTarget);\n    button.fadeOut(1000);\n    $(document).trigger('ui_button_pressed');\n  });\n\n  $(document).bind('ui_button_pressed', function() {\n    console.log('ui_button_pressed evt');\n    self.fsm.ui_button_pressed();\n  });\n}\nButtonView.prototype.fadeIn = function() {\n  this.startButton.fadeIn();\n}\n\n\n// Everything required to set up the app.\n$(window).ready(function() {\n  var socketProxy = new SocketProxy();\n  var appState = new AppState();\n\n  window.io = window.io || undefined;\n\n  var layer = new SocketLayer(window.io, socketProxy)\n  layer.init();\n\n  window.p = new PhotoView(window.Config, appState);\n  bv = new ButtonView();\n  snackbar = new Snackbar(socketProxy);\n\n  var ssm = new ShmileStateMachine(window.p, socketProxy, appState, window.Config, bv, snackbar)\n\n  bv.fsm = ssm.fsm;\n\n  window.socketProxy = socketProxy;\n\n  socketProxy.on('template', function(template){\n    layer.register(ssm.fsm);\n    bv.render();\n    snackbar.render();\n    p.render(template);\n    ssm.fsm.connected();\n  });\n\n  socketProxy.on('configsChanged', function() {\n    window.location.reload(false);\n  });\n\n});\n\nvar Snackbar = function(socket) {\n  this.socket = socket;\n}\nSnackbar.prototype.render = function() {\n  this.snackbar = document.getElementById('snackbar');\n}\nSnackbar.prototype.pressed = function() {\n  this.socket.emit(\"print\")\n  this.hideMe();\n}\nSnackbar.prototype.showMe = function() {\n  if (self.snackbar.classClass !== \"showMe\") {\n    this.snackbar.className = \"showMe\";\n  }\n}\nSnackbar.prototype.hideMe = function() {\n  var self = this;\n  if (self.snackbar.className === \"showMe\") {\n    self.snackbar.className = \"hideMe\";\n    setTimeout(function() {\n      self.snackbar.className = \"\";\n    }, 2300);\n  }\n}\n\nvar PortraitOneByFour = function(config) {\n  this.photoBorder = 0;\n  this.totalPictures = 4;\n  this.finalSizeRatio = 2/6;\n}\n\nPortraitOneByFour.prototype.render = function(stuff) {\n  var compositeDim = stuff.compositeDim;\n  var paper = stuff.paper;\n  var compositeOrigin = stuff.compositeOrigin;\n  var frames = stuff.frames;\n  var images = stuff.images;\n  var all = stuff.all;\n\n  // Scale the photo padding too\n  this.photoBorder = compositeDim.w / 50;\n\n  //upper x\n  var frame_x = compositeOrigin.x + this.photoBorder;\n  var frame_y = compositeOrigin.y + this.photoBorder;\n  \n  var _frame_w = (compositeDim.w - (2*this.photoBorder));\n\n  this.frameDim = {\n    w: (compositeDim.w - (2*this.photoBorder)),\n    h: _frame_w * 4/6 // TODO: Fixed aspect ratio?\n  };\n  var frame = paper.rect(frame_x, frame_y, this.frameDim.w, this.frameDim.h);\n  frame.attr({'fill': 'black'});\n  var img = paper.image(null, frame_x, frame_y, this.frameDim.w, this.frameDim.h);\n\n  images.push(img);\n  frames.push(frame);\n  all.push(img);\n  all.push(frame);\n\n  for (var i = 0; i < 3; i++) {\n    frame = frame.clone();\n    img = img.clone();\n    frame.translate(0, this.frameDim.h + this.photoBorder);\n    img.translate(0, this.frameDim.h + this.photoBorder);\n    frames.push(frame);\n    images.push(img);\n    all.push(frame);\n    all.push(img);\n  }\n\n  return this.frameDim;\n}\n\nvar LandscapeTwoByTwo = function(config) {\n    this.photoBorder = 0;\n    this.totalPictures = 4;\n    this.finalSizeRatio = 6/4;\n  }\n\nLandscapeTwoByTwo.prototype.render = function(stuff) {\n  var compositeDim = stuff.compositeDim;\n  var paper = stuff.paper;\n  var compositeOrigin = stuff.compositeOrigin;\n  var frames = stuff.frames;\n  var images = stuff.images;\n  var all = stuff.all;\n\n  // Scale the photo padding too\n  this.photoBorder = compositeDim.w / 50;\n\n  //upper x\n  var frame_x = compositeOrigin.x + this.photoBorder;\n  var frame_y = compositeOrigin.y + this.photoBorder;\n  this.frameDim = {\n      w: (compositeDim.w - (3*this.photoBorder))/2,\n      h: (compositeDim.h - (3*this.photoBorder))/2\n  };\n  var frame = paper.rect(frame_x, frame_y, this.frameDim.w, this.frameDim.h);\n  frame.attr({'fill': 'black'});\n  var img = paper.image(null, frame_x, frame_y, this.frameDim.w, this.frameDim.h);\n\n  images.push(img);\n  frames.push(frame);\n  all.push(img);\n  all.push(frame);\n\n  frame = frame.clone();\n  img = img.clone();\n  frame.translate(this.frameDim.w + this.photoBorder, 0);\n  img.translate(this.frameDim.w + this.photoBorder, 0);\n  frames.push(frame);\n  images.push(img);\n  all.push(frame);\n  all.push(img);\n\n  frame = frame.clone();\n  img = img.clone();\n  frame.translate(-(this.frameDim.w + this.photoBorder), this.frameDim.h + this.photoBorder);\n  img.translate(-(this.frameDim.w + this.photoBorder), this.frameDim.h + this.photoBorder);\n  frames.push(frame);\n  images.push(img);\n  all.push(frame);\n  all.push(img);\n\n  frame = frame.clone();\n  img = img.clone();\n  frame.translate(this.frameDim.w + this.photoBorder, 0);\n  img.translate(this.frameDim.w + this.photoBorder, 0);\n  frames.push(frame);\n  images.push(img);\n  all.push(frame);\n  all.push(img);\n\n  return this.frameDim;\n\n}\n\nvar LandscapeOneByThree = function(config) {\n  this.totalPictures = 3;\n  this.size =  {w: 2000, h: 750};\n  this.frameSize = {w: 633.33, h:422.22}\n  this.frameSpacing = 50;\n  this.finalSizeRatio = 8/3;\n}\n\nLandscapeOneByThree.prototype.render = function(stuff) {\n  var compositeDim = stuff.compositeDim;\n  var paper = stuff.paper;\n  var compositeOrigin = stuff.compositeOrigin;\n  var frames = stuff.frames;\n  var images = stuff.images;\n  var all = stuff.all;\n\n  var scaleFactor = compositeDim.h / this.size.h;\n\n  var frameDim = {\n    w: scaleFactor * this.frameSize.w,\n    h: scaleFactor * this.frameSize.h\n  }\n  var spacing = this.frameSpacing * scaleFactor;\n  var frame = paper.rect(compositeOrigin.x, compositeOrigin.y + spacing, frameDim.w, frameDim.h);\n  frame.attr({'fill': 'black', 'id': 'frame0'});\n  var img = paper.image(null, compositeOrigin.x, compositeOrigin.y + spacing, frameDim.w, frameDim.h);\n\n  images.push(img);\n  frames.push(frame);\n  all.push(img);\n  all.push(frame);\n\n  for (var i = 1; i < 3; i++) {\n    frame = frame.clone();\n    img = img.clone();\n    frame.translate(spacing + frameDim.w, 0);\n    frame.attr({'id': 'frame' + i});\n    img.translate(spacing + frameDim.w, 0);\n    frames.push(frame);\n    images.push(img);\n    all.push(frame);\n    all.push(img);\n  }\n\n  return frameDim;\n}\n\nvar SnapOneByFour = function(config) {\n    this.config = config;\n    // this.paper = Snap('#viewport', his.config.window_width, this.config.window_height);\n    this.paper = Snap();\n    this.paper.attr({\n      viewBox: [0, 0, 2000, 750]\n    });\n    Snap.select('#viewport').append(this.paper);\n    // this.frames = this.paper.group(); // List of SVG black rects\n    // this.images = this.paper.group(); // List of SVG images\n    // this.all = this.paper.group();\n    // this.overlayImage = null;\n    // this.photoBorder = 0;\n    // this.compositeDim = null;\n    // this.frameDim = null;\n    // this.compositeOrigin = null;\n    // this.compositeCenter = null;\n    // this.state = state;\n    this.totalPictures = 3;\n    // this.overlay = null;\n    // this.photoViewLayout = null;\n\n    // Snap.plugin( function( Snap, Element, Paper, global ) {\n    //   Element.prototype.getCenter = function() {\n    //     var bbox = this.getBBox();\n    //     return [bbox.cx, bbox.cy]\n    //   };\n    // });\n\n    // Polyfill for getTransformToElement as Chrome 48 has deprecated it, may be able to simplify globalToLocal now and leave out polyfill\n    SVGElement.prototype.getTransformToElement = SVGElement.prototype.getTransformToElement || function(elem) {\n      return elem.getScreenCTM().inverse().multiply(this.getScreenCTM());\n    };\n\n    Snap.plugin( function( Snap, Element, Paper, global ) {\n      Element.prototype.hide = function() {\n        this.attr({ 'opacity': 0.0 });\n        // var bbox = this.getBBox();\n        // return [bbox.cx, bbox.cy]\n      };\n      Element.prototype.show = function() {\n        this.attr({ 'opacity': 1.0 });\n        // var bbox = this.getBBox();\n        // return [bbox.cx, bbox.cy]\n      };\n      Element.prototype.getCenter = function() {\n        var bbox = this.getBBox();\n        return {x: bbox.cx, y:bbox.cy};\n      };\n      Element.prototype.getSize = function() {\n        var bbox = this.getBBox();\n        return {w: bbox.width, h:bbox.height};\n      };\n      Element.prototype.getPos = function() {\n        var bbox = this.getBBox();\n        return {x: bbox.x, y:bbox.y};\n      };\n      Element.prototype.getTransformRelative = function(relativeObj, type, absolute, xadjust, yadjust) {\n        var movex = 0;\n        var movey = 0;\n        switch (type) {\n          case \"center\":\n          var c = relativeObj.getCenter();\n          var elpos = this.getPos();\n          var elsize = this.getSize();\n          var movex = c.x - (elsize.w / 2);\n          var movey = c.y - (elsize.h / 2);\n\n          movex = (elpos.x > movex ? 0 - (elpos.x - movex) : movex - elpos.x);\n          movey = (elpos.y > movey ? 0 - (elpos.y - movey) : movey - elpos.y);\n          break;\n          case \"topleft\":\n          var movepos = relativeObj.getPos();\n          var elpos = this.getPos();\n\n          movex = (elpos.x > movepos.x ? 0 - (elpos.x - movepos.x) : movepos.x - elpos.x);\n          movey = (elpos.y > movepos.y ? 0 - (elpos.y - movepos.y) : movepos.y - elpos.y);\n          break;\n          case \"bottomleft\":\n          var movepos = relativeObj.getBBox();\n          var elpos = this.getPos();\n\n          movex = (elpos.x > movepos.x ? 0 - (elpos.x - movepos.x) : movepos.x - elpos.x);\n          movey = (elpos.y > movepos.y2 ? 0 - (elpos.y - movepos.y2) : movepos.y2 - elpos.y);\n          break;\n          case \"topright\":\n          var movepos = relativeObj.getPos();\n          var rsize = relativeObj.getSize();\n          var elsize = this.getSize();\n          var elpos = this.getPos();\n\n          movex = (elpos.x > movepos.x ? 0 - (elpos.x - movepos.x) : movepos.x - elpos.x);\n          movey = (elpos.y > movepos.y ? 0 - (elpos.y - movepos.y) : movepos.y - elpos.y);\n          movex += rsize.w - elsize.w;\n          break;\n          case \"bottomright\":\n          var movepos = relativeObj.getBBox();\n          var rsize = relativeObj.getSize();\n          var elsize = this.getSize();\n          var elpos = this.getPos();\n\n          movex = (elpos.x > movepos.x2 ? 0 - (elpos.x - movepos.x2) : movepos.x2 - elpos.x);\n          movey = (elpos.y > movepos.y2 ? 0 - (elpos.y - movepos.y2) : movepos.y2 - elpos.y);\n          break;\n          case \"topcenter\":\n          var c = relativeObj.getCenter();\n          var rpos = relativeObj.getPos();\n          var elpos = this.getPos();\n          var elsize = this.getSize();\n          var movex = c.x - (elsize.w / 2);\n\n          movex = (elpos.x > movex ? 0 - (elpos.x - movex) : movex - elpos.x);\n          movey = (elpos.y > rpos.y ? 0 - (elpos.y - rpos.y) : rpos.y - elpos.y);\n          break;\n          case \"bottomcenter\":\n          var c = relativeObj.getCenter();\n          var rpos = relativeObj.getBBox();\n          var elpos = this.getPos();\n          var elsize = this.getSize();\n          var movex = c.x - (elsize.w / 2);\n\n          movex = (elpos.x > movex ? 0 - (elpos.x - movex) : movex - elpos.x);\n          movey = (elpos.y > rpos.y2 ? 0 - (elpos.y - rpos.y2) : rpos.y2 - elpos.y);\n          break;\n          case \"leftcenter\":\n          var c = relativeObj.getCenter();\n          var rpos = relativeObj.getPos();\n          var elpos = this.getPos();\n          var elsize = this.getSize();\n          var movey = c.y - (elsize.h / 2);\n\n          movex = (elpos.x > rpos.x ? 0 - (elpos.x - rpos.x) : rpos.x - elpos.x);\n          movey = (elpos.y > movey ? 0 - (elpos.y - movey) : movey - elpos.y);\n          break;\n          case \"rightcenter\":\n          var c = relativeObj.getCenter();\n          var rbox = relativeObj.getBBox();\n          var elpos = this.getPos();\n          var elsize = this.getSize();\n          var movey = c.y - (elsize.h / 2);\n\n          movex = (elpos.x > rbox.x2 ? 0 - (elpos.x - rbox.x2) : rbox.x2 - elpos.x);\n          movey = (elpos.y > movey ? 0 - (elpos.y - movey) : movey - elpos.y);\n          break;\n          default:\n          console.log(\"ERROR: Unknown transform type in getTransformRelative!\");\n          break;\n        }\n\n        if (typeof(xadjust) === 'undefined') xadjust = 0;\n        if (typeof(yadjust) === 'undefined') yadjust = 0;\n        movex = movex + xadjust;\n        movey = movey + yadjust;\n\n        return (absolute ? \"T\"+movex+\",\"+movey : \"t\"+movex+\",\"+movey);\n      };\n\n      Element.prototype.getCenterPoint = function( x, y ) {\n        var pt = this.paper.node.createSVGPoint();\n        var center = this.getCenter();\n        pt.x = center.x; pt.y = center.y;\n        return pt.matrixTransform( this.paper.node.getScreenCTM().inverse());\n      };\n\n      Element.prototype.globalToLocal = function( globalPoint ) {\n        var globalToLocal = this.node.getTransformToElement( this.paper.node ).inverse();\n        globalToLocal.e = globalToLocal.f = 0;\n        return globalPoint.matrixTransform( globalToLocal );\n      };\n\n      Element.prototype.zoomToFit = function() {\n        //paper -> global?\n        //var pt1 = frame1.getCursorPoint(paper.getCenterPoint().x,paper.getCenterPoint().y)\n        // var pt = frame1.globalToLocal(pt1)\n        // undefined\n        // var t = \"t\" + [pt.x, pt.y]\n        // undefined\n        // t\n        // \"t354.1203918457031,132.8743133544922\"\n        // window.p.photoViewLayout.paper.animate({transform: t}, 1000, mina.easeinout);\n\n\n        var centerPoint = this.getCenterPoint();\n\n        var paperPoint = this.paper.getCenterPoint()\n        var pt = this.paper.node.createSVGPoint();\n\n        pt.x = paperPoint.x - centerPoint.x;\n        pt.y = paperPoint.y - centerPoint.y;\n\n        var localPt = this.globalToLocal( pt );\n        var localMatrix = this.transform().localMatrix;\n\n        // return this.transform( localMatrix.toTransformString() + \"t\" + [  localPt.x, localPt.y ] );\n        return  localMatrix.toTransformString() + \"t\" + [  localPt.x, localPt.y ] ;\n      };\n\n\n      Element.prototype.ztf = function (stuff) {\n        // paper -> global?\n        var centerPoint = stuff.getCenterPoint();\n        var pt1 = this.getCursorPoint(centerPoint.x, centerPoint.y)\n        var pt = this.globalToLocal(pt1)\n        // undefined\n        var t = \"t\" + [pt.x, pt.y]\n        return t;\n        // undefined\n        // t\n        // \"t354.1203918457031,132.8743133544922\"\n        // window.p.photoViewLayout.paper.animate({transform: t}, 1000, mina.easeinout);\n      }\n      Element.prototype.getCursorPoint = function( x, y ) {\n        var pt = this.paper.node.createSVGPoint();\n        pt.x = x; pt.y = y;\n        return pt.matrixTransform( this.paper.node.getScreenCTM().inverse());\n      };\n\n      Element.prototype.altDrag = function() {\n        return this.drag( altMoveDrag, altStartDrag );\n      };\n\n      function altMoveDrag( xxdx, xxdy, ax, ay ) {\n        var tdx, tdy;\n        var cursorPoint = this.getCursorPoint( ax, ay );\n        var pt = this.paper.node.createSVGPoint();\n\n        pt.x = cursorPoint.x - this.data('op').x;\n        pt.y = cursorPoint.y - this.data('op').y;\n\n        var localPt = this.globalToLocal( pt );\n\n        this.transform( this.data('ot').toTransformString() + \"t\" + [  localPt.x, localPt.y ] );\n\n      };\n\n      function altStartDrag( x, y, ev ) {\n        this.data('ibb', this.getBBox());\n        this.data('op', this.getCursorPoint( x, y ));\n        this.data('ot', this.transform().localMatrix);\n      };\n    });\n\n  }\n\nSnapOneByFour.prototype.render = function(cb) {\n  var snap = this.paper;\n  Snap.load(\"/images/drawing.svg\", function(data){\n    var el = data.select(\"svg\");\n  //   el.attr({'id':'paper'\n  // // });\n  // // , 'width':window.Config.window_width - 50\n  // , 'width': \"95%\"\n  // , 'height': \"95%\", 'display': \"block\", 'margin': \"auto\"});\n  // ,'height':window.Config.window_height - 50});\n    // el.transform('t0,'+0+'s'+compositeDim.w/755.91);\n\n    snap.append(el)\n    if (cb) {\n      var overlay = el.select('#layer3');\n      cb(overlay);\n    }\n  });\n  return this.paper;\n\n\n    // var w = this.config.window_width - this.config.photo_margin;\n    // var h = this.config.window_height - this.config.photo_margin;\n    // this.compositeDim = CameraUtils.scale4x1(w, h);\n    // this.compositeOrigin = {\n    //     x: (this.config.window_width - this.compositeDim.w) / 2,\n    //     y: (this.config.window_height - this.compositeDim.h) / 2\n    // };\n    // this.compositeCenter = {\n    //     x: this.compositeOrigin.x + (this.compositeDim.w/2),\n    //     y: this.compositeOrigin.y + (this.compositeDim.h/2)\n    // }\n    // var r = this.paper.rect(this.compositeOrigin.x, this.compositeOrigin.y, this.compositeDim.w, this.compositeDim.h);\n    //\n    // r.attr({'fill': 'white'});\n    //\n    // this.paper.append(r);\n    //\n    // // Scale the photo padding too\n    // this.photoBorder = this.compositeDim.w / 50;\n    //\n    //     //upper x\n    // var frame_x = this.compositeOrigin.x + this.photoBorder;\n    // var frame_y = this.compositeOrigin.y + this.photoBorder;\n    //\n    // var _frame_w = (this.compositeDim.w - (2*this.photoBorder));\n    //\n    // this.frameDim = {\n    //     w: (this.compositeDim.w - (2*this.photoBorder)),\n    //     h: _frame_w * 4/6 // TODO: Fixed aspect ratio?\n    // };\n    // var frame = this.paper.rect(frame_x, frame_y, this.frameDim.w, this.frameDim.h);\n    // frame.attr({'fill': 'black'});\n    // var img = this.paper.image(null, frame_x, frame_y, this.frameDim.w, this.frameDim.h);\n    //\n    // this.images.append(img);\n    // this.frames.append(frame);\n    // // this.all.append(img);\n    // // this.all.append(frame);\n    //\n    // for (var i = 1; i < 4; i++) {\n    //   frame = frame.clone();\n    //   img = img.clone();\n    //   frame.transform('t0,'+(i*(this.frameDim.h + this.photoBorder)));\n    //   img.transform('t0,'+(i*(this.frameDim.h + this.photoBorder)));\n    //   this.frames.append(frame);\n    //   this.images.append(img);\n    //   // this.all.append(frame);\n    //   // this.all.append(img);\n    // }\n    //\n    // // return [this.paper, this.all];\n    // return this.paper;\n    //\n    // // // Draw the PNG logo overlay.\n    // // var o = this.paper.image(\n    // //     '/images/overlay_david.png',\n    // //     this.compositeOrigin.x,\n    // //     this.compositeOrigin.y,\n    // //     this.compositeDim.w,\n    // //     this.compositeDim.h);\n    // // this.all.push(o);\n    // // this.overlayImage = o;\n    //\n    // // Hide everything and move out of sight.\n    // // this.all.hide();\n    // // this.all.translate(-this.config.window_width, 0);\n  }\n\nSnapOneByFour.prototype.toString = function() {\n    ret = [];\n    ret.push(\"Size of 'all' set: \" + this.all.length);\n    ret.push(\"Size of 'frames' set: \" + this.frames.length);\n    ret.push(\"Composite photo is: \" + this.all[0].attr('width') + 'x' + this.all[0].attr('height'));\n    ret.push(\"Frame photo is: \" + this.frameDim.w + 'x' + this.frameDim.h);\n    return ret.join('\\n');\n  }\n\n  /**\n   * Updates the image at the set location.\n   * @param {String} img_src\n   *   The URL of the image resource the browser should fetch and display\n   * @param {Integer} idx\n   *   Index of frame to update\n   * @param cb\n   *   The callback to be executed when the UI has finished updating and zooming out.\n   */\n  SnapOneByFour.prototype.updatePhotoSet = function(img_src, idx, cb) {\n    var view = this;\n    var frameEl = view.select('#frame'+(idx + 1));\n    var imgEl = frameEl.clone();\n\n    return [imgEl, frameEl]\n    // imgEl.attr({'src': img_src, 'opacity': 0});\n    // imgEl.show();\n    //\n    // var afterShowPhoto = function () {\n    //   // We've found and revealed the photo, now hide the old black rect and zoom out\n    //   frameEl.hide();\n    //   p.zoomFrame(idx, 'out', cb);\n    // }\n    // imgEl.animate({'opacity': 1}, 200, afterShowPhoto);\n  }\n\n\n\n  /**\n   * zoomFrame zooms into the indicated frame.\n   * Call it once to zoom in, call it again to zoom out.\n   *\n   * @param idx Frame index\n   *   Expect zoomFrame(1) to be matched immediately by zoomFrame(1)\n   * frame: 0 (upper left), 1 (upper-right), 2 (lower-left), 3 (lower-right)\n   * @param dir 'in' or 'out'\n   *   Zoom in or out\n   * @param onfinish\n   *   Callback executed when the animation is finished.\n   *\n   * Depends on the presence of the .zoomed object to store zoom info.\n   */\n  SnapOneByFour.prototype.zoomFrame = function(idx, dir, state, onfinish) {\n      var view = this.paper;\n      // var composite = this.all[idx];\n\n      var bbox = view.select('#frame' + (idx + 1)).getBBox();\n      var frameX = bbox.x;//frame.attr('x');\n      var frameW = bbox.width;//frame.attr('width');\n      var frameY = bbox.y;//frame.attr('y');\n      var frameH = bbox.height;//frame.attr('height');\n      var centerX = bbox.cx;//frameX + frameW/2;\n      var centerY = bbox.cy;//frameY + frameH/2;\n\n      var animSpeed = 1000;\n\n      // delta to translate to.\n      // var dx = (window.Config.window_width/2) - centerX;\n      // var dy = (window.Config.window_height/2) - centerY;\n\n      var svg = Snap.select('svg');\n      var b = svg.getBBox();\n\n      var compositeCenter = { x: b.cx,\n                              y: b.cy };\n      // var compositeCenter = { x: window.Config.window_width / 2,\n      //                         y: window.Config.window_height / 2 };\n\n      var dx = compositeCenter.x - centerX;\n      var dy =  compositeCenter.y - centerY;\n      var scaleFactor = b.width / frameW;\n      if (dir === \"out\" && state.zoomed) {\n          scaleFactor = 1;\n          dx = -state.zoomed.dx;\n          dy = -state.zoomed.dy;\n          view.animate({\n              transform: 's' + [1, 1, compositeCenter.x, compositeCenter.y].join(','),\n          }, animSpeed, mina.bounce, //onFinish);\n          function() {\n              view.animate({\n                  'translation': dx+','+dy\n              }, animSpeed, mina.easeInOut, onfinish)\n          });\n          return null;\n      } else if (dir !== \"out\") {\n          view.animate({\n              transform: 't'+ dx+','+ dy\n              // transform: 's' + [1, 1, centerX, centerY].join(','),\n          }, animSpeed, mina.easeInOut);//, function() {\n          //     view.animate({\n          //         transform: 's' + [scaleFactor, scaleFactor, compositeCenter.x, compositeCenter.y].join(','),\n          //     }, animSpeed, mina.bounce, onfinish)\n          // });\n          // Store the zoom data for next zoom.\n          return  {\n              dx: dx,\n              dy: dy,\n              scaleFactor: scaleFactor\n          };\n      }\n  }\n\nSnapOneByFour.prototype.removeImages = function () {\n  // // this.images.clear();\n  // for (var i = 0; i < this.totalPictures; i++) {\n  //   this.images.pop();\n  // }\n  // this.images.hide();\n  // this.frames.show();\n}\n\nSnapOneByFour.prototype.createOverlayImage = function() {\n  return this.paper.select('#layer3');\n  // return this.overlay;\n  // return this.paper.image(\n    //   overlayImage,\n    //   this.compositeOrigin.x,\n    //   this.compositeOrigin.y,\n    //   this.compositeDim.w,\n    //   this.compositeDim.h);\n  }\n\n// SnapOneByFour.prototype.set = function() {\n//   return this.paper.set();\n// }\n\nvar StripOneByThree = function(config) {\n    this.photoBorder = 0;\n    this.totalPictures = 3;\n    this.skipFrame = 1 - 1;\n    this.finalSizeRatio = 2/6;\n  }\n\nStripOneByThree.prototype.render = function(stuff) {\n    var compositeDim = stuff.compositeDim;\n    var paper = stuff.paper;\n    var compositeOrigin = stuff.compositeOrigin;\n    var frames = stuff.frames;\n    var images = stuff.images;\n    var all = stuff.all;\n\n    // Scale the photo padding too\n    this.photoBorder = compositeDim.w / 50;\n\n        //upper x\n    var frame_x = compositeOrigin.x + this.photoBorder;\n    var frame_y = compositeOrigin.y + this.photoBorder;\n\n    var _frame_w = (compositeDim.w - (2*this.photoBorder));\n\n    var frameDim = {\n        w: _frame_w, //(compositeDim.w - (2*this.photoBorder)),\n        h: _frame_w * 4/6 // TODO: Fixed aspect ratio?\n    };\n    var frame = paper.rect(frame_x, frame_y, frameDim.w, frameDim.h);\n    frame.attr({'fill': 'black'});\n    var img = paper.image(null, frame_x, frame_y, frameDim.w, frameDim.h);\n\n    images.push(img);\n    frames.push(frame);\n    all.push(img);\n    all.push(frame);\n\n    for (var i = 0; i < 2; i++) {\n      if (i == this.skipFrame) {\n        frame.translate(0, frameDim.h + this.photoBorder);\n        img.translate(0, frameDim.h + this.photoBorder);\n      }\n      frame = frame.clone();\n      img = img.clone();\n      frame.translate(0, frameDim.h + this.photoBorder);\n      img.translate(0, frameDim.h + this.photoBorder);\n      frames.push(frame);\n      images.push(img);\n      all.push(frame);\n      all.push(img);\n    }\n\n    return frameDim;\n  }\n"]}