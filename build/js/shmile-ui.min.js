function CameraUtils(){}CameraUtils.snap=function(t,i){p.zoomFrame(t,"in"),p.modalMessage("Ready?",Config.ready_delay,200,function(){p.modalMessage("3",1e3,200,function(){p.modalMessage("2",1e3,200,function(){p.modalMessage("1",1e3,200,function(){i()})})})})},CameraUtils.scale4x6=function(t,i){var e=1.5,o=t/i;return o>=e?{w:6*i/4,h:i}:{w:t,h:4*t/6}};var Config={photo_margin:50,window_width:$(window).width(),window_height:$(window).height()-10,overlay_delay:2e3,next_delay:1e4,cheese_delay:400,flash_duration:1e3,ready_delay:2e3,nice_delay:5e3,between_snap_delay:1e3,is_mobile:!1},State={photoset:[],set_id:null,current_frame_idx:0,zoomed:null};ShmileStateMachine=function(t,i,e,o){var n=this;return n.photoView=t,n.socket=i,n.State=e,n.Config=o,StateMachine.create({initial:"loading",events:[{name:"connected",from:"loading",to:"ready"},{name:"ui_button_pressed",from:"ready",to:"waiting_for_photo"},{name:"photo_saved",from:"waiting_for_photo",to:"review_photo"},{name:"photo_updated",from:"review_photo",to:"next_photo"},{name:"continue_partial_set",from:"next_photo",to:"waiting_for_photo"},{name:"finish_set",from:"next_photo",to:"review_composited"},{name:"next_set",from:"review_composited",to:"ready"}],callbacks:{onconnected:function(){n.photoView.animate("in",function(){startButton.fadeIn()})},onenterready:function(){n.photoView.resetState()},onleaveready:function(){},onenterwaiting_for_photo:function(){cheeseCb=function(){n.photoView.modalMessage("Cheese!",o.cheese_delay),n.photoView.flashStart(),i.emit("snap",!0)},CameraUtils.snap(n.State.current_frame_idx,cheeseCb)},onphoto_saved:function(t,i,e,s){n.photoView.flashEnd(),n.photoView.updatePhotoSet(s.web_url,n.State.current_frame_idx,function(){setTimeout(function(){fsm.photo_updated()},o.between_snap_delay)})},onphoto_updated:function(){n.photoView.flashEnd(),3==n.State.current_frame_idx?fsm.finish_set():(n.State.current_frame_idx=(n.State.current_frame_idx+1)%4,fsm.continue_partial_set())},onenterreview_composited:function(){i.emit("composite"),n.photoView.showOverlay(!0),setTimeout(function(){fsm.next_set()},o.next_delay)},onleavereview_composited:function(){n.photoView.animate("out"),n.photoView.modalMessage("Nice!",o.nice_delay,200,function(){n.photoView.slideInNext()})},onchangestate:function(t,i,e){console.log("fsm received event "+t+", changing state from "+i+" to "+e)}}})};var SocketLayer=function(t,i){this.socket=t.connect("/"),this.fsm=i};SocketLayer.prototype.register=function(){var t=this;this.socket.on("message",function(t){console.log("data is"+t)}),this.socket.on("connect",function(){console.log("connected evt"),t.fsm.connected()}),this.socket.on("camera_snapped",function(){console.log("camera_snapped evt")}),this.socket.on("photo_saved",function(i){console.log("photo_saved evt: "+i.filename),t.fsm.photo_saved(i)})};var PhotoView=Backbone.View.extend({id:"#viewport",initialize:function(t){this.config=t,this.canvas=new Raphael("viewport",this.config.window_width,this.config.window_height),this.frames=this.canvas.set(),this.images=this.canvas.set(),this.all=this.canvas.set(),this.overlayImage=null,this.photoBorder=0,this.compositeDim=null,this.frameDim=null,this.compositeOrigin=null,this.compositeCenter=null},render:function(){var t=this.config.window_width-this.config.photo_margin,i=this.config.window_height-this.config.photo_margin;this.compositeDim=CameraUtils.scale4x6(t,i),this.compositeOrigin={x:(this.config.window_width-this.compositeDim.w)/2,y:(this.config.window_height-this.compositeDim.h)/2},this.compositeCenter={x:this.compositeOrigin.x+this.compositeDim.w/2,y:this.compositeOrigin.y+this.compositeDim.h/2};var e=this.canvas.rect(this.compositeOrigin.x,this.compositeOrigin.y,this.compositeDim.w,this.compositeDim.h);e.attr({fill:"white"}),this.all.push(e),this.photoBorder=this.compositeDim.w/50;var o=this.compositeOrigin.x+this.photoBorder,n=this.compositeOrigin.y+this.photoBorder;this.frameDim={w:(this.compositeDim.w-3*this.photoBorder)/2,h:(this.compositeDim.h-3*this.photoBorder)/2};var s=this.canvas.rect(o,n,this.frameDim.w,this.frameDim.h);s.attr({fill:"black"});var a=this.canvas.image(null,o,n,this.frameDim.w,this.frameDim.h);this.images.push(a),this.frames.push(s),this.all.push(a),this.all.push(s),s=s.clone(),a=a.clone(),s.translate(this.frameDim.w+this.photoBorder,0),a.translate(this.frameDim.w+this.photoBorder,0),this.frames.push(s),this.images.push(a),this.all.push(s),this.all.push(a),s=s.clone(),a=a.clone(),s.translate(-(this.frameDim.w+this.photoBorder),this.frameDim.h+this.photoBorder),a.translate(-(this.frameDim.w+this.photoBorder),this.frameDim.h+this.photoBorder),this.frames.push(s),this.images.push(a),this.all.push(s),this.all.push(a),s=s.clone(),a=a.clone(),s.translate(this.frameDim.w+this.photoBorder,0),a.translate(this.frameDim.w+this.photoBorder,0),this.frames.push(s),this.images.push(a),this.all.push(s),this.all.push(a);var h=this.canvas.image("/images/overlay.png",this.compositeOrigin.x,this.compositeOrigin.y,this.compositeDim.w,this.compositeDim.h);this.all.push(h),this.overlayImage=h,this.all.hide(),this.all.translate(-this.config.window_width,0)},toString:function(){return ret=[],ret.push("Size of 'all' set: "+this.all.length),ret.push("Size of 'frames' set: "+this.frames.length),ret.push("Composite photo is: "+this.all[0].attr("width")+"x"+this.all[0].attr("height")),ret.push("Frame photo is: "+this.frameDim.w+"x"+this.frameDim.h),ret.join("\n")},updatePhotoSet:function(t,i,e){var o=this,n=o.images[i],s=o.frames[i];n.attr({src:t,opacity:0}),n.show();var a=function(){s.hide(),p.zoomFrame(i,"out",e)};n.animate({opacity:1},200,a)},animate:function(t,i){"in"===t?(this.all.show(),this.images.hide(),this.overlayImage.hide(),this.all.animate({translation:this.config.window_width+",0"},1e3,"<>",i)):"out"===t&&this.all.animate({translation:this.config.window_width+",0"},1e3,"<>",i)},zoomFrame:function(t,i,e){var o=this,n=(this.all[t],this.frames[t]),s=n.attr("x"),a=n.attr("width"),h=n.attr("y"),r=n.attr("height"),c=s+a/2,m=h+r/2,l=700,d=this.compositeCenter.x-c,f=this.compositeCenter.y-m,p=this.compositeDim.w/this.frameDim.w;"out"===i&&State.zoomed?(p=1,d=-State.zoomed.dx,f=-State.zoomed.dy,o.all.animate({scale:[1,1,o.compositeCenter.x,o.compositeCenter.y].join(",")},l,"bounce",function(){o.all.animate({translation:d+","+f},l,"<>",e)}),State.zoomed=null):"out"!==i&&(o.all.animate({translation:d+","+f},l,"<>",function(){o.all.animate({scale:[p,p,o.compositeCenter.x,o.compositeCenter.y].join(",")},l,"bounce",e)}),State.zoomed={dx:d,dy:f,scaleFactor:p})},slideInNext:function(){this.resetState(),this.modalMessage("Next!"),this.all.hide(),this.all.translate(2*-this.config.window_width,0),this.animate("in",function(){$("#start-button").fadeIn()})},resetState:function(){State={photoset:[],set_id:null,current_frame_idx:0,zoomed:null}},flashEffect:function(t){void 0===t&&(t=200);var i=this.canvas.rect(0,0,this.config.window_width,this.config.window_height);i.attr({fill:"white",opacity:0}),i.animate({opacity:1},t,">",function(){i.animate({opacity:0},t,"<"),i.remove()})},flashStart:function(t){void 0===t&&(t=200),this.rect=this.canvas.rect(0,0,this.config.window_width,this.config.window_height),this.rect.attr({fill:"white",opacity:0}),this.rect.animate({opacity:1},t,">")},flashEnd:function(t){void 0===t&&(t=200);var i=this;this.rect.animate({opacity:0},t,"<",function(){i.remove()})},modalMessage:function(t,i,e,o){if(void 0===e)var e=200;if(void 0===i)var i=500;var n=.3*this.config.window_height,s=(this.config.window_width-n)/2,a=(this.config.window_height-n)/2,h=this.canvas.set(),r=this.canvas.rect(s,a,n,n,15);r.attr({fill:"#222","fill-opacity":.7,"stroke-color":"white"}),h.push(r);var c=this.canvas.text(s+n/2,a+n/2,t);c.attr({fill:"white","font-size":"50","font-weight":"bold"}),h.push(c),h.attr({opacity:0}),h.animate({opacity:1,scale:"1.5,1.5","font-size":"70"},e,">");setTimeout(function(){c.remove(),r.remove(),o&&o()},i,h)},showOverlay:function(t){this.overlayImage.show(),t&&this.overlayImage.animate({opacity:1},this.config.overlay_delay)},hideOverlay:function(t){var i=this;t?this.overlayImage.animate({opacity:0},this.config.overlay_delay,function(){i.overlayImage.hide()}):this.overlayImage.hide()}}),ButtonView=function(){};ButtonView.prototype.render=function(){startButton=$("button#start-button");var t=(Config.window_width-startButton.outerWidth())/2,i=(Config.window_height-startButton.outerHeight())/2;startButton.hide(),startButton.css({top:i,left:t});var e=Config.is_mobile?"touchend":"click";startButton.bind(e,function(t){var i=$(t.currentTarget);i.fadeOut(1e3),$(document).trigger("ui_button_pressed")}),$(document).bind("ui_button_pressed",function(){console.log("ui_button_pressed evt"),fsm.ui_button_pressed()})},$(window).ready(function(){var t=$('<div id="mockSocket">');$("body").append(t),window.socket="undefined"==typeof socket?t:window.socket,window.io=window.io||{connect:function(){return window.socket}},window.p=new PhotoView(window.Config),window.fsm=new ShmileStateMachine(window.p,window.socket,window.State,window.Config);var i=new SocketLayer(io,window.fsm);i.register(),bv=new ButtonView,bv.render(),p.render()});
//# sourceMappingURL=../maps/shmile-ui.js.map